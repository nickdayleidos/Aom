@page "/acr/{Id:int}/edit"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using Microsoft.AspNetCore.Components.Authorization
@inject IAcrQueryService Query
@inject IAcrService Acr
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthState

<MudPaper Class="pa-2" Outlined="true">
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.subtitle2">Time display</MudText>
        <MudSelect T="TimeDisplayMode" Dense @bind-Value="_mode">
            <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (employee site)</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain</MudSelectItem>
        </MudSelect>
    </MudStack>
</MudPaper>

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined>
        @if (_vm is null)
        {
            <MudProgressLinear Indeterminate />
        }
        else
        {
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h6">Edit ACR #@_vm.Id</MudText>
                <MudSpacer />
                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           OnClick="SaveAsync">
                    Save
                </MudButton>
            </MudStack>

            <MudDivider Class="my-2" />

            <MudGrid>
                @if (_vm.TypeKey == AcrTypeKey.NewHire)
                {
                    @* New Hire: just show the edit form full-width *@
                    <MudItem xs="12" md="12">
                        <AcrFormHost Value="_vm"
                                     ValueChanged="OnVmChanged"
                                     Mode="_mode" />
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12" md="5">
                        <PreviousDetails Value="@_mirror"
                                         EmployeeId="@_vm.EmployeeId"
                                         ShowOrg="@(_vm.Organization is not null)"
                                         ShowSchedule="@(_vm.Schedule is not null)"
                                         ShowOvertime="@((_vm.Overtime is not null) ||
                                                                                                  (_vm.Schedule?.IsOtAdjustment ?? false))"
                                 Mode="_mode" />
            </MudItem>

                    <MudItem xs="12" md="7">
                        <AcrFormHost Value="_vm"
                                     ValueChanged="OnVmChanged"
                                     Mode="_mode" />
                    </MudItem>
                        }
            </MudGrid>
        }
    </MudPaper>
</MudStack>

@code {
    [Parameter] public int Id { get; set; }

    private AcrEditVm? _vm;
    private AcrCreateVm? _mirror;
    private TimeDisplayMode _mode = TimeDisplayMode.EmployeeLocal;

    protected override async Task OnParametersSetAsync()
    {
        // 1. Check Permissions
        var statusId = await Query.GetStatusIdByAcrIdAsync(Id);
        if (!statusId.HasValue)
        {
            Snackbar.Add("ACR not found.", Severity.Error);
            Nav.NavigateTo("/acr");
            return;
        }

        var authState = await AuthState.GetAuthenticationStateAsync();
        var user = authState.User;
        var isAuth = false;

        if (statusId.Value == 1) // Submitted
        {
            // Admin, WFM, Manager, Supervisor
            if (user.IsInRole("Admin") || user.IsInRole("WFM") || user.IsInRole("Manager") || user.IsInRole("Supervisor"))
            {
                isAuth = true;
            }
        }
        else // Any other status
        {
            // Only Admin, WFM
            if (user.IsInRole("Admin") || user.IsInRole("WFM"))
            {
                isAuth = true;
            }
        }

        if (!isAuth)
        {
            Snackbar.Add("You are not authorized to edit this ACR in its current status.", Severity.Error);
            Nav.NavigateTo($"/acr/{Id}");
            return;
        }

        // 2. Load Data
        _vm = await Query.LoadForEditAsync(Id);
        RebuildMirror();
    }

    private void RebuildMirror()
    {
        if (_vm is null)
        {
            _mirror = null;
            return;
        }

        _mirror = new AcrCreateVm
        {
            EmployeeId = _vm.EmployeeId,
            TypeId = _vm.TypeId,
            EffectiveDate = _vm.EffectiveDate,
            SubmitterComment = _vm.SubmitterComment,
            IncludeOvertimeAdjustment = _vm.IncludeOvertimeAdjustment,
            Organization = _vm.Organization,
            Schedule = _vm.Schedule,
            Overtime = _vm.Overtime
        };
    }

    private Task OnVmChanged(object? value)
    {
        if (value is AcrEditVm e)
        {
            _vm = e;
            RebuildMirror();
        }
        return Task.CompletedTask;
    }

    // --- Save Logic (SIMPLIFIED) ---
    private async Task SaveAsync()
    {
        if (_vm is null) return;
        if (!_vm.EffectiveDate.HasValue)
        {
            Snackbar.Add("Effective Date is required.", Severity.Error);
            return;
        }

        // FIX: No manual conversion here.
        // AcrService.UpdateAsync handles Local -> Eastern conversion internally.
        await Acr.UpdateAsync(_vm);

        Snackbar.Add("ACR updated.", Severity.Success);
        Nav.NavigateTo("/acr");
    }
}