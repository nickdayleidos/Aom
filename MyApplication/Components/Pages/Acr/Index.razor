@page "/acr"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using System.Linq
@using MudBlazor
@using MyApplication.Components.Service.Acr

@inject IAcrQueryService Query
@inject NavigationManager Nav

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined>

        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">ACRs</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="@(() => Nav.NavigateTo("/acr/new"))">
                New
            </MudButton>
        </MudStack>

        <MudTabs @bind-ActivePanelIndex="TabIndex"
                 Rounded="true"
                 Elevation="0"
                 Class="mt-2">
            <MudTabPanel Text="All ACRs" Icon="@Icons.Material.Outlined.ListAlt" />
            <MudTabPanel Text="Manager Approve" Icon="@Icons.Material.Outlined.Badge" />
            <MudTabPanel Text="WFM Approve" Icon="@Icons.Material.Outlined.CheckCircleOutline" />
        </MudTabs>

        <MudGrid Class="mt-3 mb-2" AlignItems="Center" GutterSize="2">
            <MudItem xs="12" md="5">
                <MudTextField T="string"
                              Label="Employee"
                              Placeholder="Search by employee name or id"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              @bind-Value="_searchText"
                              Immediate="true"
                              DebounceInterval="500"
                              OnDebounceIntervalElapsed="OnSearchChanged" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="int?"
                           Label="Type"
                           Dense="true"
                           Clearable="true"
                           Value="_selectedTypeId"
                           ValueChanged="OnTypeChanged"
                           Class="w-100">
                    <MudSelectItem Value="@((int?)null)">All Types</MudSelectItem>
                    @foreach (var kv in _types)
                    {
                        <MudSelectItem Value="@((int?)kv.Key)">@kv.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="int?"
                           Label="Status"
                           Dense="true"
                           Clearable="true"
                           Disabled="@(TabIndex != 0)"
                           Value="_selectedStatusId"
                           ValueChanged="OnStatusChanged"
                           Class="w-100">
                    <MudSelectItem Value="@((int?)null)">All Statuses</MudSelectItem>
                    @foreach (var kv in _statuses)
                    {
                        <MudSelectItem Value="@((int?)kv.Key)">@kv.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="1" Class="d-flex justify-end">
                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Outlined.ClearAll"
                           OnClick="ClearFilters">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudTable T="AcrRequestListItem"
                  ServerData="@ServerReload"
                  @ref="_table"
                  Hover="true"
                  Dense="true"
                  Bordered="true"
                  RowClick="OnRowClick"
                  RowsPerPage="50">

            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel SortLabel="EmployeeName" T="AcrRequestListItem">Employee</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="AcrType" T="AcrRequestListItem">Type</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="AcrStatus" T="AcrRequestListItem">Status</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="EffectiveDate" T="AcrRequestListItem">Effective</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="SubmitTime" T="AcrRequestListItem" InitialDirection="SortDirection.Descending">Submitted</MudTableSortLabel>
                </MudTh>
                <MudTh></MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.EmployeeName</MudTd>
                <MudTd>@context.AcrType</MudTd>
                <MudTd>@(context.AcrStatus ?? "-")</MudTd>
                <MudTd>@context.EffectiveDate</MudTd>
                <MudTd>@(context.SubmitTime?.ToString("yyyy-MM-dd HH:mm") ?? "-")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   OnClick="@(e => Nav.NavigateTo($"/acr/{context.Id}"))"
                                   OnClick:stopPropagation="true" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No items found</MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-4">
                    <MudProgressCircular Indeterminate="true" />
                </MudStack>
            </LoadingContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 200 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudStack>

@code
{
    private const int StatusSubmitted = 1;
    private const int StatusManagerApproved = 2;

    private MudTable<AcrRequestListItem> _table; // Reference to table

    private int _tabIndex;
    private int TabIndex
    {
        get => _tabIndex;
        set
        {
            if (_tabIndex == value) return;
            _tabIndex = value;
            _table?.ReloadServerData(); // Reload table when tab changes
        }
    }

    private string _searchText = string.Empty;

    private Dictionary<int, string> _types = new();
    private Dictionary<int, string> _statuses = new();

    private int? _selectedTypeId;
    private int? _selectedStatusId;

    private AcrIndexFilter _filter = new(null, null, null, null, null);

    protected override async Task OnInitializedAsync()
    {
        _types = await Query.GetTypesAsync();
        _statuses = await Query.GetStatusesAsync();
    }

    // --- Filters / search ---------------------------------------------------

    private void OnSearchChanged(string text)
    {
        _searchText = text;
        _table.ReloadServerData();
    }

    private void OnTypeChanged(int? value)
    {
        _selectedTypeId = value;
        _table.ReloadServerData();
    }

    private void OnStatusChanged(int? value)
    {
        _selectedStatusId = value;
        _table.ReloadServerData();
    }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _selectedTypeId = null;
        _selectedStatusId = null;

        _filter = _filter with
        {
            AcrTypeId = null,
            AcrStatusId = null,
            EmployeeSearch = null,
            EffectiveFrom = null,
            EffectiveTo = null
        };
        _table.ReloadServerData();
    }

    // --- Data load (ServerData) ----------------------------------------------------------

    private async Task<TableData<AcrRequestListItem>> ServerReload(TableState state, CancellationToken ct)
    {
        int? statusId = null;

        if (TabIndex == 1) statusId = StatusSubmitted;
        else if (TabIndex == 2) statusId = StatusManagerApproved;
        else statusId = _selectedStatusId;

        var search = string.IsNullOrWhiteSpace(_searchText) ? null : _searchText.Trim();

        _filter = _filter with
        {
            AcrTypeId = _selectedTypeId,
            AcrStatusId = statusId,
            EmployeeSearch = search
        };

        var sortDescending = state.SortDirection == SortDirection.Descending;

        // Call the new Search Service
        var result = await Query.SearchAsync(
            _filter,
            state.Page,
            state.PageSize,
            state.SortLabel,
            sortDescending,
            ct);

        return new TableData<AcrRequestListItem>()
        {
            TotalItems = result.TotalCount,
            Items = result.Items
        };
    }

    private void OnRowClick(TableRowClickEventArgs<AcrRequestListItem> e)
        => Nav.NavigateTo($"/acr/{e.Item.Id}");
}