@page "/acr"
@attribute [Authorize(Policy = "Admin")]
@using System.Linq
@using MudBlazor
@using MyApplication.Components.Service.Acr

@inject IAcrQueryService Query
@inject NavigationManager Nav

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined>

        <!-- Header ---------------------------------------------------------->
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">ACRs</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="@(() => Nav.NavigateTo("/acr/new"))">
                New
            </MudButton>
        </MudStack>

        <!-- Tabs ------------------------------------------------------------>
        <MudTabs @bind-ActivePanelIndex="TabIndex"
                 Rounded="true"
                 Elevation="0"
                 Class="mt-2">
            <MudTabPanel Text="All ACRs"
                         Icon="@Icons.Material.Outlined.ListAlt" />
            <MudTabPanel Text="Manager Approve"
                         Icon="@Icons.Material.Outlined.Badge" />
            <MudTabPanel Text="WFM Approve"
                         Icon="@Icons.Material.Outlined.CheckCircleOutline" />
        </MudTabs>
        <!-- Filter bar ------------------------------------------------------>
        <MudGrid Class="mt-3 mb-2" AlignItems="Center" GutterSize="2">
            <!-- Search -->
            <MudItem xs="12" md="5">
                <MudTextField T="string"
                              Label="Employee"
                              Placeholder="Search by employee name or id"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              @bind-Value="_searchText"
                              Immediate="true"
                              DebounceInterval="200"
                              OnDebounceIntervalElapsed="OnSearchChanged" />
            </MudItem>

            <!-- Type filter -->
            <MudItem xs="12" md="3">
                <MudSelect T="int?" Label="Type"
                           Dense="true"
                           Clearable="true"
                           Value="_selectedTypeId"
                           ValueChanged="OnTypeChanged"
                           Class="w-100">
                    <MudSelectItem Value="@((int?)null)">All Types</MudSelectItem>
                    @foreach (var kv in _types)
                    {
                        <MudSelectItem Value="@((int?)kv.Key)">@kv.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <!-- Status filter (disabled on Manager/WFM tabs) -->
            <MudItem xs="12" md="3">
                <MudSelect T="int?" Label="Status"
                           Dense="true"
                           Clearable="true"
                           Disabled="@(TabIndex != 0)"
                           Value="_selectedStatusId"
                           ValueChanged="OnStatusChanged"
                           Class="w-100">
                    <MudSelectItem Value="@((int?)null)">All Statuses</MudSelectItem>
                    @foreach (var kv in _statuses)
                    {
                        <MudSelectItem Value="@((int?)kv.Key)">@kv.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <!-- Clear filters -->
            <MudItem xs="12" md="1" Class="d-flex justify-end">
                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Outlined.ClearAll"
                           OnClick="ClearFilters">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>

        <!-- Table ----------------------------------------------------------->
        <MudTable Items="_rows"
                  Hover="true"
                  Dense="true"
                  Bordered="true"
                  Loading="_loading"
                  RowClick="OnRowClick">

            <HeaderContent>
                <MudTh>Employee</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Effective</MudTh>
                <MudTh>Submitted</MudTh>
                <MudTh></MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.EmployeeName</MudTd>
                <MudTd>@context.AcrType</MudTd>
                <MudTd>@(context.AcrStatus ?? "-")</MudTd>
                <MudTd>@context.EffectiveDate</MudTd>
                <MudTd>@(context.SubmitTime?.ToString("yyyy-MM-dd HH:mm") ?? "-")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   OnClick="@(e => Nav.NavigateTo($"/acr/{context.Id}"))"
                                   OnClick:stopPropagation="true" />
                </MudTd>
            </RowTemplate>

            <LoadingContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-4">
                    <MudProgressCircular Indeterminate="true" />
                </MudStack>
            </LoadingContent>
        </MudTable>
    </MudPaper>
</MudStack>

@code
{
    private const int StatusSubmitted = 1;
    private const int StatusManagerApproved = 2;

    private int _tabIndex;
    private int TabIndex
    {
        get => _tabIndex;
        set
        {
            if (_tabIndex == value) return;
            _tabIndex = value;
            _ = ReloadAsync();
        }
    }

    private bool _loading;
    private string _searchText = string.Empty;

    private Dictionary<int, string> _types = new();
    private Dictionary<int, string> _statuses = new();

    private int? _selectedTypeId;
    private int? _selectedStatusId;

    private AcrIndexFilter _filter = new(null, null, null, null, null);
    private List<AcrRequestListItem> _rows = new();

    protected override async Task OnInitializedAsync()
    {
        _types = await Query.GetTypesAsync();
        _statuses = await Query.GetStatusesAsync();
        await ReloadAsync();
    }

    // --- Filters / search ---------------------------------------------------

    private Task OnSearchChanged(string text)
    {
        _searchText = text;
        return ReloadAsync();
    }

    private Task OnTypeChanged(int? value)
    {
        _selectedTypeId = value;
        return ReloadAsync();
    }

    private Task OnStatusChanged(int? value)
    {
        _selectedStatusId = value;
        return ReloadAsync();
    }

    private async Task ClearFilters()
    {
        _searchText = string.Empty;
        _selectedTypeId = null;
        _selectedStatusId = null;

        _filter = _filter with
        {
            AcrTypeId = null,
            AcrStatusId = null,
            EmployeeSearch = null,
            EffectiveFrom = null,
            EffectiveTo = null
        };

        await ReloadAsync();
    }

    // --- Data load ----------------------------------------------------------

    private async Task ReloadAsync()
    {
        _loading = true;
        StateHasChanged();

        int? statusId = null;

        if (TabIndex == 1)
        {
            // Manager Approve tab
            statusId = StatusSubmitted;
        }
        else if (TabIndex == 2)
        {
            // WFM Approve tab
            statusId = StatusManagerApproved;
        }
        else
        {
            // All tab = whatever user picked in Status dropdown
            statusId = _selectedStatusId;
        }

        var search = string.IsNullOrWhiteSpace(_searchText)
            ? null
            : _searchText.Trim();

        // Send filters to the query service
        _filter = _filter with
        {
            AcrTypeId = _selectedTypeId,
            AcrStatusId = statusId,
            EmployeeSearch = search
        };

        var rows = await Query.QueryAsync(_filter, take: 1000);

        // 🔍 Extra safety: client-side filter by Employee name or id
        if (!string.IsNullOrWhiteSpace(search))
        {
            var term = search.Trim();

            rows = rows
                .Where(r =>
                    (!string.IsNullOrWhiteSpace(r.EmployeeName) &&
                     r.EmployeeName.Contains(term, StringComparison.OrdinalIgnoreCase))
                    || r.EmployeeId.ToString().Contains(term, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        _rows = rows;

        _loading = false;
        StateHasChanged();
    }


    private void OnRowClick(TableRowClickEventArgs<AcrRequestListItem> e)
        => Nav.NavigateTo($"/acr/{e.Item.Id}");
}
