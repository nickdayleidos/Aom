@page "/tools/acr"
@using System.Linq
@using MyApplication.Components.Service.Acr
@using MyApplication.Common.Time
@inject IAcrQueryService Query
@inject NavigationManager Nav

<MudStack Spacing="2">
    <MudPaper Class="pa-3" Outlined="true">
        <MudGrid>
            <MudItem xs="12" md="2">
                <MudSelect T="int?" @bind-Value="_typeId" Label="Type" Clearable="true" Dense="true">
                    @foreach (var kv in _types)
                    {
                        <MudSelectItem T="int?" Value="@((int?)kv.Key)">@kv.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2">
                <MudSelect T="int?" @bind-Value="_statusId" Label="Status" Clearable="true" Dense="true">
                    @foreach (var kv in _statuses)
                    {
                        <MudSelectItem T="int?" Value="@((int?)kv.Key)">@kv.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_empSearch" Label="Employee (Id or name)" Dense="true" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudDatePicker @bind-Date="_from" Label="Effective from" Dense="true" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudDatePicker @bind-Date="_to" Label="Effective to" Dense="true" />
            </MudItem>

            <MudItem xs="12" md="1" Class="d-flex align-center">
                <MudButton OnClick="Load" Variant="Variant.Filled">Filter</MudButton>
            </MudItem>

            <!-- Rows selector -->
            <MudItem xs="12" md="1">
                <MudSelect T="int" @bind-Value="PageSize" Label="Rows" Dense="true">
                    <MudSelectItem Value="50">50</MudSelectItem>
                    <MudSelectItem Value="100">100</MudSelectItem>
                    <MudSelectItem Value="200">200</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Outlined="true">
        <MudTable Items="_rows" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Employee</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Effective</MudTh>
                <MudTh>Submitted (ET)</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Id">@context.Id</MudTd>
                <MudTd>@context.EmployeeName (@context.EmployeeId)</MudTd>
                <MudTd>@context.AcrType</MudTd>
                <MudTd>@context.AcrStatus</MudTd>
                <MudTd>@context.EffectiveDate.ToString("yyyy-MM-dd")</MudTd>
                <MudTd>@FormatEt(context.SubmitTime)</MudTd>
                <MudTd>
                    <MudButton Size="Size.Small" OnClick="@(() => Nav.NavigateTo($"/tools/acr/{context.Id}"))">
                        Details
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-2">
            <MudText Typo="Typo.body2">
                Page @_currentPage of @_pageCount (@_all.Count total)
            </MudText>

            <MudStack Row="true" Spacing="1">
                <MudButton Variant="Variant.Outlined" Disabled="@(_currentPage <= 1)" OnClick="PrevPage">
                    <MudIcon Icon="@Icons.Material.Filled.NavigateBefore" /> Prev
                </MudButton>
                <MudButton Variant="Variant.Outlined" Disabled="@(_currentPage >= _pageCount)" OnClick="NextPage">
                    Next <MudIcon Icon="@Icons.Material.Filled.NavigateNext" />
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-3" Outlined="true">
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => Nav.NavigateTo("/tools/acr/new"))">
            New ACR
        </MudButton>
    </MudPaper>
</MudStack>

@code {
    Dictionary<int, string> _types = new();
    Dictionary<int, string> _statuses = new();

    int? _typeId;
    int? _statusId;
    string? _empSearch;
    DateTime? _from;
    DateTime? _to;

    List<AcrRequestListItem> _all = new();
    List<AcrRequestListItem> _rows = new();

    private int _pageSize = 50;
    private int PageSize
    {
        get => _pageSize;
        set
        {
            _pageSize = value;
            _currentPage = 1;
            ApplyPagination();
        }
    }

    private int _currentPage = 1;
    private int _pageCount = 1;

    protected override async Task OnInitializedAsync()
    {
        _types = await Query.GetTypesAsync();
        _statuses = await Query.GetStatusesAsync();
        await Load();
    }

    private async Task Load()
    {
        var f = new AcrIndexFilter(
            _typeId,
            _statusId,
            _empSearch,
            _from is null ? null : DateOnly.FromDateTime(_from.Value),
            _to is null ? null : DateOnly.FromDateTime(_to.Value)
        );

        _all = (await Query.QueryAsync(f))
            .OrderByDescending(r => r.EffectiveDate)
            .ThenByDescending(r => r.SubmitTime)
            .Take(1000)
            .ToList();

        _currentPage = 1;
        ApplyPagination();
    }

    private void ApplyPagination()
    {
        _pageCount = (int)Math.Ceiling(_all.Count / (double)_pageSize);
        _currentPage = Math.Clamp(_currentPage, 1, Math.Max(1, _pageCount));

        _rows = _all
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize)
            .ToList();

        StateHasChanged();
    }

    private void NextPage()
    {
        if (_currentPage < _pageCount)
        {
            _currentPage++;
            ApplyPagination();
        }
    }

    private void PrevPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            ApplyPagination();
        }
    }

    private static string? FormatEt(DateTime? dt)
    {
        if (dt is null) return null;
        return dt.Value.Kind == DateTimeKind.Utc
            ? Et.FromUtc(dt.Value).ToString("g")
            : dt.Value.ToString("g");
    }
}
