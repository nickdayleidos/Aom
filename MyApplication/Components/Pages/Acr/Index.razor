@page "/acr"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using System.Linq
@using MudBlazor
@using MyApplication.Components.Service.Acr

@inject IAcrQueryService Query
@inject NavigationManager Nav

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined="true">

        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">ACRs</MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="@(() => Nav.NavigateTo("/acr/new"))">
                New Request
            </MudButton>
        </MudStack>

        <MudTabs @bind-ActivePanelIndex="TabIndex"
                 Rounded="true"
                 Elevation="0"
                 Color="Color.Transparent"
                 Class="mt-2">
            <MudTabPanel Text="All ACRs" Icon="@Icons.Material.Outlined.ListAlt" />
            <MudTabPanel Text="Manager Approve" Icon="@Icons.Material.Outlined.Badge" />
            <MudTabPanel Text="WFM Approve" Icon="@Icons.Material.Outlined.CheckCircleOutline" />
        </MudTabs>

        <MudDivider Class="my-3" />

        <MudGrid Spacing="2" AlignItems="Center">

            <MudItem xs="12" md="3">
                <MudTextField T="string"
                              Placeholder="Search (Name or ID)..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              @bind-Value="_searchText"
                              Immediate="true"
                              DebounceInterval="500"
                              OnDebounceIntervalElapsed="OnSearchChanged"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Clearable="true" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string>?"
                                 Label="Type"
                                 Dense="true"
                                 Clearable="true"
                                 MaxItems="null"
                                 Value="_selectedTypeKv"
                                 ValueChanged="OnTypeKvChanged"
                                 SearchFunc="SearchTypes"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string>?"
                                 Label="Status"
                                 Dense="true"
                                 Clearable="true"
                                 MaxItems="null"
                                 Disabled="@(TabIndex != 0)"
                                 Value="_selectedStatusKv"
                                 ValueChanged="OnStatusKvChanged"
                                 SearchFunc="SearchStatuses"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string>?"
                                 Label="Manager"
                                 Dense="true"
                                 Clearable="true"
                                 MaxItems="null"
                                 Value="_selectedManagerKv"
                                 ValueChanged="OnManagerKvChanged"
                                 SearchFunc="SearchManagers"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string>?"
                                 Label="Supervisor"
                                 Dense="true"
                                 Clearable="true"
                                 MaxItems="null"
                                 Value="_selectedSupervisorKv"
                                 ValueChanged="OnSupervisorKvChanged"
                                 SearchFunc="SearchSupervisors"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="12" md="12" Class="d-flex justify-space-between align-center mt-1">
                <MudSwitch T="bool" Value="_activeOnly" ValueChanged="OnActiveOnlyChanged" Color="Color.Primary" Label="Active Employees Only" />

                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Outlined.FilterAltOff"
                           OnClick="ClearFilters"
                           Size="Size.Small">
                    Reset Filters
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudTable T="AcrRequestListItem"
                  ServerData="@ServerReload"
                  @ref="_table"
                  Hover="true"
                  Dense="true"
                  Bordered="false"
                  Striped="true"
                  RowClick="OnRowClick"
                  RowsPerPage="50"
                  Class="mt-4"
                  Elevation="0">

            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel SortLabel="EmployeeName" T="AcrRequestListItem">Employee</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="AcrType" T="AcrRequestListItem">Type</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="AcrStatus" T="AcrRequestListItem">Status</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="EffectiveDate" T="AcrRequestListItem">Effective</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="SubmitTime" T="AcrRequestListItem" InitialDirection="SortDirection.Descending">Submitted</MudTableSortLabel>
                </MudTh>
                <MudTh Style="width: 50px;"></MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.EmployeeName</MudTd>
                <MudTd>@context.AcrType</MudTd>
                <MudTd>
                    <MudChip T="int" Size="Size.Small" Variant="Variant.Text" Color="Color.Default">@(context.AcrStatus ?? "-")</MudChip>
                </MudTd>
                <MudTd>@context.EffectiveDate.ToString("MM/dd/yyyy")</MudTd>
                <MudTd>@(context.SubmitTime?.ToString("MM/dd/yyyy HH:mm") ?? "-")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowForward"
                                   Size="Size.Small"
                                   Href="@($"/acr/{context.Id}")" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4 text-center">No ACRs found matching these filters.</MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-4">
                    <MudProgressCircular Indeterminate="true" />
                </MudStack>
            </LoadingContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 200 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudStack>

@code
{
    private const int StatusSubmitted = 1;
    private const int StatusManagerApproved = 2;

    private MudTable<AcrRequestListItem> _table;

    private int _tabIndex;
    private int TabIndex
    {
        get => _tabIndex;
        set { if (_tabIndex != value) { _tabIndex = value; _table?.ReloadServerData(); } }
    }

    private string _searchText = string.Empty;
    // Data Sources
    private Dictionary<int, string> _types = new();
    private Dictionary<int, string> _statuses = new();
    private List<KeyValuePair<int, string>> _managers = new();
    private List<KeyValuePair<int, string>> _supervisors = new();
    // Bound Objects for Autocompletes
    private KeyValuePair<int, string>? _selectedTypeKv;
    private KeyValuePair<int, string>? _selectedStatusKv;
    private KeyValuePair<int, string>? _selectedManagerKv;
    private KeyValuePair<int, string>? _selectedSupervisorKv;

    // Derived IDs for Filtering
    private int? _selectedTypeId => _selectedTypeKv?.Key;
    private int? _selectedStatusId => _selectedStatusKv?.Key;
    private int? _selectedManagerId => _selectedManagerKv?.Key;
    private int? _selectedSupervisorId => _selectedSupervisorKv?.Key;

    private bool _activeOnly = true;
    private AcrIndexFilter _filter = new(null, null, null, null, null, null, null, true);
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var tTypes = Query.GetTypesAsync();
            var tStatus = Query.GetStatusesAsync();
            var tManagers = Query.GetManagersAsync();
            var tSupervisors = Query.GetSupervisorsAsync();

            await Task.WhenAll(tTypes, tStatus, tManagers, tSupervisors);

            _types = tTypes.Result;
            _statuses = tStatus.Result;
            _managers = tManagers.Result;
            _supervisors = tSupervisors.Result;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading lookups: {ex.Message}");
        }
    }

    // --- Search Helpers for Autocompletes ---

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchTypes(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_types.Select(x => (KeyValuePair<int, string>?)x));
        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _types.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                  .Select(x => (KeyValuePair<int, string>?)x));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchStatuses(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_statuses.Select(x => (KeyValuePair<int, string>?)x));
        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _statuses.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                     .Select(x => (KeyValuePair<int, string>?)x));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchManagers(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_managers.Select(x => (KeyValuePair<int, string>?)x));
        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _managers.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                     .Select(x => (KeyValuePair<int, string>?)x));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchSupervisors(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_supervisors.Select(x => (KeyValuePair<int, string>?)x));
        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _supervisors.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                        .Select(x => (KeyValuePair<int, string>?)x));
    }

    // --- Change Handlers ---

    private void OnSearchChanged(string text) { _searchText = text; _table.ReloadServerData(); }

    private void OnTypeKvChanged(KeyValuePair<int, string>? val) { _selectedTypeKv = val; _table.ReloadServerData(); }
    private void OnStatusKvChanged(KeyValuePair<int, string>? val) { _selectedStatusKv = val; _table.ReloadServerData(); }
    private void OnManagerKvChanged(KeyValuePair<int, string>? val) { _selectedManagerKv = val; _table.ReloadServerData(); }
    private void OnSupervisorKvChanged(KeyValuePair<int, string>? val) { _selectedSupervisorKv = val; _table.ReloadServerData(); }

    private void OnActiveOnlyChanged(bool value) { _activeOnly = value; _table.ReloadServerData(); }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _selectedTypeKv = null;
        _selectedStatusKv = null;
        _selectedManagerKv = null;
        _selectedSupervisorKv = null;
        _activeOnly = true;
        _table.ReloadServerData();
    }

    // --- Data Loading ---

    private async Task<TableData<AcrRequestListItem>> ServerReload(TableState state, CancellationToken ct)
    {
        int? statusId = null;

        if (TabIndex == 1) statusId = StatusSubmitted;
        else if (TabIndex == 2) statusId = StatusManagerApproved;
        else statusId = _selectedStatusId; // Uses the computed property from KV

        var search = string.IsNullOrWhiteSpace(_searchText) ? null : _searchText.Trim();

        _filter = new AcrIndexFilter(
            _selectedTypeId,       // Uses computed property
            statusId,
            search,
            _selectedManagerId,    // Uses computed property
            _selectedSupervisorId, // Uses computed property
            null,
            null,
            _activeOnly
        );
        var sortDescending = state.SortDirection == SortDirection.Descending;

        var result = await Query.SearchAsync(
            _filter,
            state.Page,
            state.PageSize,
            state.SortLabel,
            sortDescending,
            ct);
        return new TableData<AcrRequestListItem>()
        {
            TotalItems = result.TotalCount,
            Items = result.Items
        };
    }

    private void OnRowClick(TableRowClickEventArgs<AcrRequestListItem> e)
        => Nav.NavigateTo($"/acr/{e.Item.Id}");
}