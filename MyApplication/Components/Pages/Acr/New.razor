@page "/acr/new"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@inject ITimeDisplayService TimeDisp

@inject IAcrService Acr
@inject IAcrQueryService Query
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudPaper Class="pa-2" Outlined="true">
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.subtitle2">Time display</MudText>
        <MudSelect T="TimeDisplayMode" Dense @bind-Value="_mode">
            <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (employee site)</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain</MudSelectItem>
        </MudSelect>
    </MudStack>
</MudPaper>

<MudStack Spacing="2">

    @* === ACR Type + Employee selectors === *@
    <MudPaper Class="pa-4" Outlined="true">
        <MudGrid Class="mt-2">
            <MudItem xs="12" md="4">
                <MudAutocomplete T="KeyValuePair<int, string>"
                                 Label="ACR Type"
                                 Dense
                                 Clearable
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 ToStringFunc="kv => kv.Value"
                                 Value="_selectedType"
                                 ValueChanged="OnTypeChanged"
                                 SearchFunc="@((string term, CancellationToken ct) => SearchTypes(term, ct))" />
            </MudItem>

            <MudItem xs="12" md="4">
                @if (!IsNewHire)
                {
                    <MudAutocomplete T="KeyValuePair<int, string>"
                                     Label="Employee"
                                     Dense
                                     Clearable
                                     ResetValueOnEmptyText="true"
                                     CoerceText="true"
                                     ToStringFunc="kv => kv.Value"
                                     Value="_selectedEmployee"
                                     ValueChanged="OnEmployeeChanged"
                                     SearchFunc="SearchEmployees" />
                }
                else
                {
                    <MudText Typo="Typo.caption" Class="opacity-70">
                        New Hire: employee will be defined in the form.
                    </MudText>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* === Left: Previous details | Right: ACR form === *@
    <MudGrid Class="mt-2">
        <MudItem xs="12" md="6">
            <PreviousDetails @key="(_selectedEmployee.Key, _selectedType.Key, _mode)"
                             Value="_vm"
                             EmployeeId="_vm.EmployeeId"
                             ShowOrg="@(_showOrg || _showNewHire || _showRehire)"
                             ShowSchedule="@(_showSchedule || _showNewHire || _showRehire)"
                             ShowOvertime="@(_vm.IncludeOvertimeAdjustment || _selectedType.Key == OvertimeOnlyTypeId)"
                             Mode="_mode" />
        </MudItem>

        <MudItem xs="12" md="6">
            <AcrFormHost @key="(_selectedEmployee.Key, _selectedType.Key, _mode)"
                         Value="_vm"
                         ValueChanged="OnVmChanged"
                         ForceShowOrg="_showOrg"
                         ForceShowSchedule="_showSchedule"
                         ForceShowOvertimeOnly="@(_selectedType.Key == OvertimeOnlyTypeId)"
                         Mode="_mode" />
        </MudItem>
    </MudGrid>

    @* === Actions === *@
    <MudStack Row Justify="Justify.FlexEnd" Class="mt-4" Spacing="2">
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Secondary"
                   OnClick="@Cancel">
            Cancel
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@IsSubmitDisabled"
                   OnClick="SaveAsync">
            Submit ACR
        </MudButton>
    </MudStack>

</MudStack>

@code {
    private AcrCreateVm _vm = new();
    private TimeDisplayMode _mode = TimeDisplayMode.EmployeeLocal;

    private Dictionary<int, string> _types = new();
    private List<KeyValuePair<int, string>> _empOptions = new();

    private KeyValuePair<int, string> _selectedType = default;
    private KeyValuePair<int, string> _selectedEmployee = default;

    private bool _showOrg, _showSchedule, _showOvertime, _showNewHire, _showSeparation, _showRehire;

    private const int OvertimeOnlyTypeId = 7;

    // 🔒 Guard: type and employee (where applicable) must be selected.
    private bool IsSubmitDisabled =>
        _vm.TypeId == 0 || (!IsNewHire && _vm.EmployeeId == 0);

    private void Cancel() => Nav.NavigateTo("/acr");

    protected override async Task OnInitializedAsync()
    {
        _types = await Query.GetTypesAsync();
    }

    private static bool? EmployeeActiveFilterForType(int typeId) => (AcrTypeKey)typeId switch
    {
        AcrTypeKey.Rehire => false,
        AcrTypeKey.Separation => true,
        AcrTypeKey.OrganizationChange => true,
        AcrTypeKey.ScheduleChange => true,
        AcrTypeKey.OrgSchedule => true,
        AcrTypeKey.OvertimeAdjustment => true,
        AcrTypeKey.NewHire => null,
        _ => null
    };

    private Task<IEnumerable<KeyValuePair<int, string>>> SearchTypes(string term, CancellationToken _)
        => Task.FromResult(_types
            .Where(kv => string.IsNullOrWhiteSpace(term) || kv.Value.Contains(term, StringComparison.OrdinalIgnoreCase))
            .Select(kv => new KeyValuePair<int, string>(kv.Key, kv.Value)));

    private bool IsNewHire => _selectedType.Key == (int)AcrTypeKey.NewHire;

    private async Task<IEnumerable<KeyValuePair<int, string>>> SearchEmployees(string term, CancellationToken ct)
    {
        if (IsNewHire) return Array.Empty<KeyValuePair<int, string>>();

        if (_empOptions.Count == 0)
        {
            var typeId = _selectedType.Key;
            var isActive = EmployeeActiveFilterForType(typeId);
            var emps = await Query.GetEmployeesLookupAsync(isActive, ct);

            _empOptions = emps
                .Select(e => new KeyValuePair<int, string>(e.Id, $"{e.LastName}, {e.FirstName}{(!string.IsNullOrEmpty(e.MiddleInitial) ? " " + e.MiddleInitial : "")} ({e.Id})"))
                .OrderBy(kv => kv.Value)
                .ToList();
        }

        if (string.IsNullOrWhiteSpace(term)) return _empOptions;

        return _empOptions.Where(kv =>
            kv.Value.Contains(term, StringComparison.OrdinalIgnoreCase) ||
            kv.Key.ToString().Contains(term, StringComparison.OrdinalIgnoreCase));
    }

    private void OnTypeChanged(KeyValuePair<int, string> v)
    {
        _selectedType = v;
        _vm = _vm with { TypeId = v.Key };

        _empOptions.Clear();
        _selectedEmployee = default;

        _showNewHire = _showSeparation = _showRehire = _showOrg = _showSchedule = _showOvertime = false;

        switch ((AcrTypeKey)v.Key)
        {
            case AcrTypeKey.NewHire:
                _showNewHire = true;
                _showOrg = true;
                _showSchedule = true;
                break;

            case AcrTypeKey.OrganizationChange:
                _showOrg = true;
                _vm = _vm with { Schedule = null, Overtime = null };
                break;

            case AcrTypeKey.ScheduleChange:
                _showSchedule = true;
                _vm = _vm with { Organization = null };
                break;

            case AcrTypeKey.OrgSchedule:
                _showOrg = true;
                _showSchedule = true;
                break;

            case AcrTypeKey.OvertimeAdjustment:
                _showOvertime = true;
                _vm = _vm with
                {
                    Organization = null,
                    Schedule = null,
                    IncludeOvertimeAdjustment = true,
                    Overtime = _vm.Overtime ?? new OvertimeAdjustmentDto(null, null, null, null, null, null, null)
                };
                break;

            case AcrTypeKey.Separation:
                _showSeparation = true;
                _vm = _vm with { Organization = null, Schedule = null, IncludeOvertimeAdjustment = false, Overtime = null };
                break;

            case AcrTypeKey.Rehire:
                _showRehire = true;
                break;
        }

        StateHasChanged();
    }

    private void OnEmployeeChanged(KeyValuePair<int, string> v)
    {
        _showNewHire = _showSeparation = _showRehire = _showOrg = _showSchedule = _showOvertime = false;
        _selectedEmployee = v;
        _vm = _vm with { EmployeeId = v.Key };
        StateHasChanged();
    }

    private Task OnVmChanged(object? v)
    {
        if (v is AcrCreateVm c)
        {
            _vm = c;
        }
        return Task.CompletedTask;
    }

    // --- Save Logic (SIMPLIFIED) ---
    private async Task SaveAsync()
    {
        if (_vm is null) return;

        if (!_vm.EffectiveDate.HasValue)
        {
            Snackbar.Add("Effective Date is required.", Severity.Error);
            return;
        }

        // FIX: Just pass _vm directly.
        // The AcrService will handle the conversion from Local -> Eastern.
        await Acr.CreateAsync(_vm);

        Snackbar.Add("ACR created.", Severity.Success);
        Nav.NavigateTo("/acr");
    }
}