@page "/acr/new"
@attribute [Authorize(Policy = "Admin")]
@inject ITimeDisplayService TimeDisp

@inject IAcrService Acr
@inject IAcrQueryService Query
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudPaper Class="pa-2" Outlined="true">
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.subtitle2">Time display</MudText>
        <MudSelect T="TimeDisplayMode" Dense @bind-Value="_mode">
            <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (employee site)</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain</MudSelectItem>
        </MudSelect>
    </MudStack>
</MudPaper>

<MudStack Spacing="2">

    @* === ACR Type + Employee selectors === *@
    <MudPaper Class="pa-4" Outlined="true">
        <MudGrid Class="mt-2">
            <MudItem xs="12" md="4">
                <MudAutocomplete T="KeyValuePair<int, string>"
                                 Label="ACR Type"
                                 Dense
                                 Clearable
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 ToStringFunc="kv => kv.Value"
                                 Value="_selectedType"
                                 ValueChanged="OnTypeChanged"
                                 SearchFunc="@((string term, CancellationToken ct) => SearchTypes(term, ct))" />
            </MudItem>

            <MudItem xs="12" md="4">
                @if (!IsNewHire)
                {
                    <MudAutocomplete T="KeyValuePair<int, string>"
                                     Label="Employee"
                                     Dense
                                     Clearable
                                     ResetValueOnEmptyText="true"
                                     CoerceText="true"
                                     ToStringFunc="kv => kv.Value"
                                     Value="_selectedEmployee"
                                     ValueChanged="OnEmployeeChanged"
                                     SearchFunc="SearchEmployees" />
                }
                else
                {
                    <MudText Typo="Typo.caption" Class="opacity-70">
                        New Hire: employee will be defined in the form.
                    </MudText>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* === Left: Previous details | Right: ACR form === *@
    <MudGrid Class="mt-2">
        <MudItem xs="12" md="6">
            <PreviousDetails @key="(_selectedEmployee.Key, _selectedType.Key, _mode)"
                             Value="_vm"
                             EmployeeId="_vm.EmployeeId"
                             ShowOrg="@(_showOrg || _showNewHire || _showRehire)"
                             ShowSchedule="@(_showSchedule || _showNewHire || _showRehire)"
                             ShowOvertime="@(_vm.IncludeOvertimeAdjustment || _selectedType.Key == OvertimeOnlyTypeId)"
                             Mode="_mode" />
        </MudItem>

        <MudItem xs="12" md="6">
            <AcrFormHost @key="(_selectedEmployee.Key, _selectedType.Key, _mode)"
                         Value="_vm"
                         ValueChanged="OnVmChanged"
                         ForceShowOrg="_showOrg"
                         ForceShowSchedule="_showSchedule"
                         ForceShowOvertimeOnly="@(_selectedType.Key == OvertimeOnlyTypeId)"
                         Mode="_mode" />
        </MudItem>
    </MudGrid>

    @* === Actions === *@
    <MudStack Row Justify="Justify.FlexEnd" Class="mt-4" Spacing="2">
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Secondary"
                   OnClick="@Cancel">
            Cancel
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@IsSubmitDisabled"
                   OnClick="SaveAsync">
            Submit ACR
        </MudButton>
    </MudStack>

</MudStack>

@code {
    private AcrCreateVm _vm = new();
    private TimeDisplayMode _mode = TimeDisplayMode.EmployeeLocal;

    private Dictionary<int, string> _types = new();
    private List<KeyValuePair<int, string>> _empOptions = new();

    private KeyValuePair<int, string> _selectedType = default;
    private KeyValuePair<int, string> _selectedEmployee = default;

    private bool _showOrg, _showSchedule, _showOvertime, _showNewHire, _showSeparation, _showRehire;

    private string? _siteWindowsTz;
    private const int OvertimeOnlyTypeId = 7; // matches your DB/type list

    // 🔒 Guard: type and employee (where applicable) must be selected.
    private bool IsSubmitDisabled =>
        _vm.TypeId == 0 || (!IsNewHire && _vm.EmployeeId == 0);

    private void Cancel()
        => Nav.NavigateTo("/acr");

    protected override async Task OnInitializedAsync()
    {
        _types = await Query.GetTypesAsync();
    }

    private static bool? EmployeeActiveFilterForType(int typeId) => (AcrTypeKey)typeId switch
    {
        AcrTypeKey.Rehire => false,
        AcrTypeKey.Separation => true,
        AcrTypeKey.OrganizationChange => true,
        AcrTypeKey.ScheduleChange => true,
        AcrTypeKey.OrgSchedule => true,
        AcrTypeKey.OvertimeAdjustment => true,
        AcrTypeKey.NewHire => null,
        _ => null
    };

    private Task<IEnumerable<KeyValuePair<int, string>>> SearchTypes(string term, CancellationToken _)
        => Task.FromResult(_types
            .Where(kv => string.IsNullOrWhiteSpace(term) || kv.Value.Contains(term, StringComparison.OrdinalIgnoreCase))
            .Select(kv => new KeyValuePair<int, string>(kv.Key, kv.Value)));

    private bool IsNewHire => _selectedType.Key == (int)AcrTypeKey.NewHire;

    private async Task<IEnumerable<KeyValuePair<int, string>>> SearchEmployees(string term, CancellationToken ct)
    {
        if (IsNewHire) return Array.Empty<KeyValuePair<int, string>>();

        if (_empOptions.Count == 0)
        {
            var typeId = _selectedType.Key;
            var isActive = EmployeeActiveFilterForType(typeId);
            var emps = await Query.GetEmployeesLookupAsync(isActive, ct);

            _empOptions = emps
                .Select(e => new KeyValuePair<int, string>(e.Id, $"{e.LastName}, {e.FirstName} ({e.Id})"))
                .OrderBy(kv => kv.Value)
                .ToList();
        }

        if (string.IsNullOrWhiteSpace(term)) return _empOptions;

        return _empOptions.Where(kv =>
            kv.Value.Contains(term, StringComparison.OrdinalIgnoreCase) ||
            kv.Key.ToString().Contains(term, StringComparison.OrdinalIgnoreCase));
    }

    private void OnTypeChanged(KeyValuePair<int, string> v)
    {
        _selectedType = v;
        _vm = _vm with { TypeId = v.Key };

        _empOptions.Clear();
        _selectedEmployee = default;

        _showNewHire = _showSeparation = _showRehire = _showOrg = _showSchedule = _showOvertime = false;

        switch ((AcrTypeKey)v.Key)
        {
            case AcrTypeKey.NewHire:
                _showNewHire = true;
                // New Hire also fills Org + Schedule
                _showOrg = true;
                _showSchedule = true;
                break;

            case AcrTypeKey.OrganizationChange:
                _showOrg = true;
                _vm = _vm with { Schedule = null, Overtime = null };
                break;

            case AcrTypeKey.ScheduleChange:
                _showSchedule = true;
                _vm = _vm with { Organization = null };
                break;

            case AcrTypeKey.OrgSchedule:
                _showOrg = true;
                _showSchedule = true;
                break;

            case AcrTypeKey.OvertimeAdjustment:
                _showOvertime = true;
                _vm = _vm with
                {
                    Organization = null,
                    Schedule = null,
                    IncludeOvertimeAdjustment = true,
                    Overtime = _vm.Overtime ?? new OvertimeAdjustmentDto(null, null, null, null, null, null, null)
                };
                break;

            case AcrTypeKey.Separation:
                _showSeparation = true;
                _vm = _vm with { Organization = null, Schedule = null, IncludeOvertimeAdjustment = false, Overtime = null };
                break;

            case AcrTypeKey.Rehire:
                _showRehire = true;
                break;
        }

        StateHasChanged();
    }

    private void OnEmployeeChanged(KeyValuePair<int, string> v)
    {
        _showNewHire = _showSeparation = _showRehire = _showOrg = _showSchedule = _showOvertime = false;
        _selectedEmployee = v;
        _vm = _vm with { EmployeeId = v.Key };
        StateHasChanged();
    }

    private Task OnVmChanged(object? v)
    {
        if (v is AcrCreateVm c)
        {
            if (_vm?.Organization?.SiteId != c.Organization?.SiteId)
                _siteWindowsTz = null;

            _vm = c;
        }
        return Task.CompletedTask;
    }

    // --- Save & TZ conversion (EffectiveDate must be set) ---

    private async Task SaveAsync()
    {
        if (_vm is null) return;

        if (!_vm.EffectiveDate.HasValue)
        {
            Snackbar.Add("Effective Date is required.", Severity.Error);
            return;
        }

        _siteWindowsTz ??= await ResolveSiteWindowsTzAsync();
        var vmToSave = ConvertScheduleToEastern(_vm, _siteWindowsTz);

        await Acr.CreateAsync(vmToSave);
        Snackbar.Add("ACR created.", Severity.Success);
        Nav.NavigateTo("/acr");
    }


    private async Task<string> ResolveSiteWindowsTzAsync()
    {
        if (_vm?.Organization?.SiteId is int siteId1)
        {
            var tz = await Query.GetSiteTimeZoneAsync(siteId1);
            if (!string.IsNullOrWhiteSpace(tz)) return tz!;
        }

        if (_vm?.EmployeeId is int empId)
        {
            var hist = await Query.GetLatestEmployeeHistoryAsync(empId);
            if (hist?.SiteId is int siteId2)
            {
                var tz = await Query.GetSiteTimeZoneAsync(siteId2);
                if (!string.IsNullOrWhiteSpace(tz)) return tz!;
            }
        }

        return "Eastern Standard Time";
    }

    private static TimeOnly? LocalToEastern(DateOnly date, TimeOnly? local, string siteWindowsTz)
    {
        if (local is null) return null;

        var tzLocal = TimeZoneInfo.FindSystemTimeZoneById(siteWindowsTz);
        var tzEast = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

        var localDt = new DateTime(date.Year, date.Month, date.Day,
                                   local.Value.Hour, local.Value.Minute, 0,
                                   DateTimeKind.Unspecified);

        var utc = TimeZoneInfo.ConvertTimeToUtc(localDt, tzLocal);
        var et = TimeZoneInfo.ConvertTimeFromUtc(utc, tzEast);

        return new TimeOnly(et.Hour, et.Minute);
    }

    private AcrCreateVm ConvertScheduleToEastern(AcrCreateVm src, string siteWindowsTz)
    {
        if (src.Schedule is null) return src;

        // 🔴 Require EffectiveDate for conversion – no fallback to Today
        if (src.EffectiveDate is null)
            throw new InvalidOperationException("Effective Date must be set before converting schedule times.");

        var ed = src.EffectiveDate.Value;
        TimeOnly? ToEt(TimeOnly? local) => LocalToEastern(ed, local, siteWindowsTz);

        var sch = src.Schedule with
        {
            MondayStart = ToEt(src.Schedule.MondayStart),
            MondayEnd = ToEt(src.Schedule.MondayEnd),
            TuesdayStart = ToEt(src.Schedule.TuesdayStart),
            TuesdayEnd = ToEt(src.Schedule.TuesdayEnd),
            WednesdayStart = ToEt(src.Schedule.WednesdayStart),
            WednesdayEnd = ToEt(src.Schedule.WednesdayEnd),
            ThursdayStart = ToEt(src.Schedule.ThursdayStart),
            ThursdayEnd = ToEt(src.Schedule.ThursdayEnd),
            FridayStart = ToEt(src.Schedule.FridayStart),
            FridayEnd = ToEt(src.Schedule.FridayEnd),
            SaturdayStart = ToEt(src.Schedule.SaturdayStart),
            SaturdayEnd = ToEt(src.Schedule.SaturdayEnd),
            SundayStart = ToEt(src.Schedule.SundayStart),
            SundayEnd = ToEt(src.Schedule.SundayEnd)
        };

        return src with { Schedule = sch };
    }
}
