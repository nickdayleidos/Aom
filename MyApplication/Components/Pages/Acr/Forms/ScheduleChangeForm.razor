@using System
@using MyApplication.Components.Service.Acr
@using MyApplication.Components.Service.Employee.Dtos
@using MyApplication.Components.Model.AOM.Employee

<MudStack Spacing="2">
    <MudText Typo="Typo.subtitle2">Schedule</MudText>

    <MudGrid Class="mb-2">
        <MudItem xs="12" md="4">
            <MudSwitch Label="Split Schedule"
                       Disabled="@ReadOnly"
                       @bind-Value="_isSplit"
                       Color="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="4">
            <MudText Typo="Typo.caption">Shift Number</MudText>
            <MudText Typo="Typo.body2">1</MudText>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudText Typo="Typo.caption" Class="opacity-75">
                Times shown in: <b>@_displayTzLabel</b>
            </MudText>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-2" Outlined>
        <MudText Typo="Typo.subtitle2">Shift 1</MudText>
        <MudTable Items="_rows1" Dense Hover>
            <HeaderContent>
                <MudTh>Day</MudTh>
                <MudTh>Start</MudTh>
                <MudTh>End</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Day">@context.Label</MudTd>
                <MudTd DataLabel="Start">
                    <MudTimePicker @bind-Time="context.Start"
                                   Editable="true"
                                   TimeFormat="HH:mm"
                                   Mask="@(new PatternMask("00:00"))"
                                   Validation="@(new Func<TimeSpan?, string?>(ValidateTime))"
                                   MinuteSelectionStep="5"
                                   Clearable="true"
                                   ReadOnly="@ReadOnly" />
                </MudTd>
                <MudTd DataLabel="End">
                    <MudTimePicker @bind-Time="context.End"
                                   Editable="true"
                                   TimeFormat="HH:mm"
                                   Mask="@(new PatternMask("00:00"))"
                                   Validation="@(new Func<TimeSpan?, string?>(ValidateTime))"
                                   MinuteSelectionStep="5"
                                   Clearable="true"
                                   ReadOnly="@ReadOnly" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>

    @if (_isSplit == true && !OvertimeOnly)
    {
        <MudPaper Class="pa-2 mt-2" Outlined>
            <MudText Typo="Typo.subtitle2">Shift 2</MudText>
            <MudAlert Severity="Severity.Info" Dense Variant="Variant.Filled" Class="mb-2">
                Shift 2 values will be saved as a separate schedule row with <b>ShiftNumber = 2</b> by the service layer.
            </MudAlert>

            <MudTable Items="_rows2" Dense Hover>
                <HeaderContent>
                    <MudTh>Day</MudTh>
                    <MudTh>Start</MudTh>
                    <MudTh>End</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Day">@context.Label</MudTd>
                    <MudTd DataLabel="Start">
                        <MudTimePicker @bind-Time="context.Start"
                                       Editable="true"
                                       TimeFormat="HH:mm"
                                       Mask="@(new PatternMask("00:00"))"
                                       Validation="@(new Func<TimeSpan?, string?>(ValidateTime))"
                                       MinuteSelectionStep="5"
                                       Clearable="true"
                                       ReadOnly="@ReadOnly" />
                    </MudTd>
                    <MudTd DataLabel="End">
                        <MudTimePicker @bind-Time="context.End"
                                       Editable="true"
                                       TimeFormat="HH:mm"
                                       Mask="@(new PatternMask("00:00"))"
                                       Validation="@(new Func<TimeSpan?, string?>(ValidateTime))"
                                       MinuteSelectionStep="5"
                                       Clearable="true"
                                       ReadOnly="@ReadOnly" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }

    <MudPaper Class="pa-2 mt-2" Outlined>
        <MudText Typo="Typo.subtitle2">Breaks &amp; Overtime</MudText>

        <MudGrid Class="mt-1">
            <MudItem xs="12" md="6" Class="mt-2">
                <MudSwitch Label="Static Break Schedule"
                           Disabled="@ReadOnly"
                           @bind-Value="_staticBreakFlag"
                           Color="Color.Primary" />
            </MudItem>

            <MudItem xs="12" md="6" Class="mt-2">
                <MudSwitch Label="Include Overtime Adjustment"
                           @bind-Value="_otFlag"
                           Color="Color.Primary" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_otFlag)
    {
        <MudPaper Class="pa-2 mt-2" Outlined>
            <OvertimeAdjustmentForm Value="OvertimeAdjustment"
                                    ValueChanged="OvertimeAdjustmentChanged"
                                    ReadOnly="@ReadOnly" />
        </MudPaper>
    }
</MudStack>

@code {
    [Parameter] public ScheduleChangeDto? Value { get; set; }
    [Parameter] public EventCallback<ScheduleChangeDto?> ValueChanged { get; set; }
    [Parameter] public bool ReadOnly { get; set; }

    [Parameter] public string? DisplayTzLabel { get; set; }
    private string _displayTzLabel => string.IsNullOrWhiteSpace(DisplayTzLabel) ? "Local (employee site)" : DisplayTzLabel;
    [Parameter] public bool OvertimeOnly { get; set; }

    [Parameter] public OvertimeAdjustmentDto? OvertimeAdjustment { get; set; }
    [Parameter] public EventCallback<OvertimeAdjustmentDto?> OvertimeAdjustmentChanged { get; set; }

    // Helper property to access Value safely without null checks everywhere
    // (We ensure it is initialized in OnParametersSet)
    private ScheduleChangeDto V => Value!;
    private bool? _isSplit
    {
        get => V.IsSplitSchedule;
        set
        {
            V.IsSplitSchedule = value;
            V.ShiftNumber = 1;
            FireChange();
        }
    }

    private bool _staticBreakFlag
    {
        get => V.IsStaticBreakSchedule ?? false;
        set
        {
            V.IsStaticBreakSchedule = value;
            FireChange();
        }
    }

    private bool _otFlag
    {
        get => V.IsOtAdjustment ?? false;
        set
        {
            V.IsOtAdjustment = value;
            FireChange();

            // Handle Overtime Child Object Logic
            if (value && OvertimeAdjustment is null)
                _ = OvertimeAdjustmentChanged.InvokeAsync(new OvertimeAdjustmentDto(null, null, null, null, null, null, null));
            if (!value && OvertimeAdjustment is not null)
                _ = OvertimeAdjustmentChanged.InvokeAsync(null);
        }
    }

    private static TimeSpan? ToSpan(TimeOnly? t) => t is null ? null : t.Value.ToTimeSpan();
    private static TimeOnly? ToTime(TimeSpan? s) => s is null ? null : TimeOnly.FromTimeSpan(s.Value);

    // Validation Logic
    private string? ValidateTime(TimeSpan? time)
    {
        // Null is allowed (Clearable=true)
        if (!time.HasValue)
            return null;

        // Check if user typed something like "25:00" or "99:99"
        if (time.Value.TotalHours >= 24)
            return "Invalid time";

        return null;
    }

    // Helper Record for binding the TimePickers
    private record SchRow(string Label,
        Func<TimeSpan?> StartGetter, Action<TimeSpan?> StartSetter,
        Func<TimeSpan?> EndGetter, Action<TimeSpan?> EndSetter)
    {
        public TimeSpan? Start { get => StartGetter(); set => StartSetter(value); }
        public TimeSpan? End { get => EndGetter(); set => EndSetter(value); }
    }

    private List<SchRow> _rows1 = new();
    private List<SchRow> _rows2 = new();

    protected override void OnInitialized()
    {
        EnsureValue();
        BuildRows();
    }

    protected override void OnParametersSet()
    {
        EnsureValue();
        BuildRows();
    }

    private void EnsureValue()
    {
        if (Value is null)
        {
            Value = new ScheduleChangeDto();
            ValueChanged.InvokeAsync(Value);
        }
    }

    private void FireChange()
    {
        // Notify parent that the object has mutated
        _ = ValueChanged.InvokeAsync(Value);
        StateHasChanged();
    }

    private void BuildRows()
    {
        // We now mutate 'V' (Value) directly and call FireChange().

        _rows1 = new()
        {
            Row("Mon", () => ToSpan(V.MondayStart),    s => { V.MondayStart    = ToTime(s); FireChange(); },
                       () => ToSpan(V.MondayEnd),      s => { V.MondayEnd      = ToTime(s); FireChange(); }),

            Row("Tue", () => ToSpan(V.TuesdayStart),   s => { V.TuesdayStart   = ToTime(s); FireChange(); },
                       () => ToSpan(V.TuesdayEnd),     s => { V.TuesdayEnd     = ToTime(s); FireChange(); }),

            Row("Wed", () => ToSpan(V.WednesdayStart), s => { V.WednesdayStart = ToTime(s); FireChange(); },
                       () => ToSpan(V.WednesdayEnd),   s => { V.WednesdayEnd   = ToTime(s); FireChange(); }),

            Row("Thu", () => ToSpan(V.ThursdayStart),  s => { V.ThursdayStart  = ToTime(s); FireChange(); },
                       () => ToSpan(V.ThursdayEnd),    s => { V.ThursdayEnd    = ToTime(s); FireChange(); }),

            Row("Fri", () => ToSpan(V.FridayStart),    s => { V.FridayStart    = ToTime(s); FireChange(); },
                       () => ToSpan(V.FridayEnd),      s => { V.FridayEnd      = ToTime(s); FireChange(); }),

            Row("Sat", () => ToSpan(V.SaturdayStart),  s => { V.SaturdayStart  = ToTime(s); FireChange(); },
                       () => ToSpan(V.SaturdayEnd),    s => { V.SaturdayEnd    = ToTime(s); FireChange(); }),

            Row("Sun", () => ToSpan(V.SundayStart),    s => { V.SundayStart    = ToTime(s); FireChange(); },
                       () => ToSpan(V.SundayEnd),      s => { V.SundayEnd      = ToTime(s); FireChange(); })
        };

        // Note: For Shift 2 (Rows2), we are just storing them in local fields for now
        // because ScheduleChangeDto only holds Shift 1.
        _rows2 = new()
        {
            Row("Mon", () => _s2MonS, s => _s2MonS = s, () => _s2MonE, s => _s2MonE = s),
            Row("Tue", () => _s2TueS, s => _s2TueS = s, () => _s2TueE, s => _s2TueE = s),
            Row("Wed", () => _s2WedS, s => _s2WedS = s, () => _s2WedE, s => _s2WedE = s),
            Row("Thu", () => _s2ThuS, s => _s2ThuS = s, () => _s2ThuE, s => _s2ThuE = s),
            Row("Fri", () => _s2FriS, s => _s2FriS = s, () => _s2FriE, s => _s2FriE = s),
            Row("Sat", () => _s2SatS, s => _s2SatS = s, () => _s2SatE, s => _s2SatE = s),
            Row("Sun", () => _s2SunS, s => _s2SunS = s, () => _s2SunE, s => _s2SunE = s),
        };
    }

    private static SchRow Row(string d, Func<TimeSpan?> sg, Action<TimeSpan?> ss, Func<TimeSpan?> eg, Action<TimeSpan?> es)
        => new(d, sg, ss, eg, es);
    private TimeSpan? _s2MonS, _s2MonE, _s2TueS, _s2TueE, _s2WedS, _s2WedE,
                      _s2ThuS, _s2ThuE, _s2FriS, _s2FriE, _s2SatS, _s2SatE, _s2SunS, _s2SunE;
}