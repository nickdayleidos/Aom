@using System.Linq
@using System.Threading
@using MudBlazor
@using MyApplication.Components.Model.AOM.Employee
@using MyApplication.Components.Service.Acr
@inherits ComponentBase

@if (!_lookupsReady)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else
{
    <MudForm @ref="_form">
        <MudGrid>
            <!-- EMPLOYEE (required) -->
            <MudItem xs="12" md="6">
                <MudAutocomplete T="Employees"
                                 @key="_vm.Employee"
                                 Label="Employee"
                                 Dense="true"
                                 Clearable="true"
                                 Required="true"
                                 RequiredError="Employee is required"
                                 @bind-Value="_vm.Employee"
                                 ToStringFunc="EmpLabel"
                                 SearchFunc="SearchEmployees" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudDatePicker Label="Effective Date"
                               @bind-Date="_vm.EffectiveDateDt"
                               Required="true"
                               RequiredError="Effective date is required" />
            </MudItem>

            <!-- Manager & Supervisor (optional) -->
            <MudItem xs="12" md="6">
                <MudAutocomplete T="Employees"
                                 @key="_vm.Manager"
                                 Label="Manager"
                                 Dense="true"
                                 Clearable="true"
                                 @bind-Value="_vm.Manager"
                                 ToStringFunc="EmpLabel"
                                 SearchFunc="@((string v, CancellationToken ct) => SearchManagers(v, ct))" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudAutocomplete T="Employees"
                                 @key="_vm.Supervisor"
                                 Label="Supervisor"
                                 Dense="true"
                                 Clearable="true"
                                 @bind-Value="_vm.Supervisor"
                                 ToStringFunc="EmpLabel"
                                 SearchFunc="@((string v, CancellationToken ct) => SearchSupervisors(v, ct))" />
            </MudItem>

           <!-- Organization -->
<MudItem xs="12" md="6">
    <MudAutocomplete T="Organization"
                     @key="_vm.Organization"
                     Label="Organization"
                     Dense="true"
                     Clearable="true"
                     @bind-Value="_vm.Organization"
                     ToStringFunc="OrgLabel"
                     SearchFunc="@((string v, CancellationToken ct) => SearchOrganizations(v, ct))"
                     @bind-Value:after="OnOrgChanged" />
</MudItem>

<!-- Sub-Organization (filtered) -->
<MudItem xs="12" md="6">
    <MudAutocomplete T="SubOrganization"
                     @key="_vm.SubOrganization"
                     Label="Sub-Organization"
                     Dense="true"
                     Clearable="true"
                     @bind-Value="_vm.SubOrganization"
                     ToStringFunc="SubOrgLabel"
                     SearchFunc="@((string v, CancellationToken ct) => SearchSubOrganizations(v, ct))"
                     Disabled="@(!_subListAny)" />
</MudItem>

            <MudItem xs="12" md="6">
                <MudAutocomplete T="Employer"
                                 @key="_vm.Employer"
                                 Label="Employer"
                                 Dense="true"
                                 Clearable="true"
                                 @bind-Value="_vm.Employer"
                                 ToStringFunc="EmployerLabel"
                                 SearchFunc="SearchEmployers" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudAutocomplete T="Site"
                                 @key="_vm.Site"
                                 Label="Site"
                                 Dense="true"
                                 Clearable="true"
                                 @bind-Value="_vm.Site"
                                 ToStringFunc="SiteLabel"
                                 SearchFunc="SearchSites" />
            </MudItem>

            <!-- Flags -->
            <MudItem xs="12" md="3"><MudCheckBox T="bool?" @bind-Value="_vm.IsActive" Label="Active" /></MudItem>
            <MudItem xs="12" md="3"><MudCheckBox T="bool?" @bind-Value="_vm.IsLoa" Label="LOA" /></MudItem>
            <MudItem xs="12" md="3"><MudCheckBox T="bool?" @bind-Value="_vm.IsIntLoa" Label="Intermittent LOA" /></MudItem>
            <MudItem xs="12" md="3"><MudCheckBox T="bool?" @bind-Value="_vm.IsRemote" Label="Remote" /></MudItem>

            <MudItem xs="12">
                <MudTextField Label="Submitter Comment"
                              @bind-Value="_vm.SubmitterComment"
                              Lines="3"
                              Immediate="true" />
            </MudItem>

            <MudItem xs="12">
                <MudButton OnClick="SubmitClicked" Color="Color.Primary" Variant="Variant.Filled">
                    @SubmitLabel
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
}

@code {
    // Lookups from parent
    [Parameter] public IEnumerable<Employees> Employees { get; set; } = Enumerable.Empty<Employees>();
    [Parameter] public IEnumerable<Employees> ManagerEmployees { get; set; } = Enumerable.Empty<Employees>();
    [Parameter] public IEnumerable<Employees> SupervisorEmployees { get; set; } = Enumerable.Empty<Employees>();
    [Parameter] public IEnumerable<Organization> Organizations { get; set; } = Enumerable.Empty<Organization>();
    [Parameter] public IEnumerable<SubOrganization> SubOrganizations { get; set; } = Enumerable.Empty<SubOrganization>();
    [Parameter] public IEnumerable<Site> Sites { get; set; } = Enumerable.Empty<Site>();
    [Parameter] public IEnumerable<Employer> Employers { get; set; } = Enumerable.Empty<Employer>();
    [Parameter] public OrganizationChangeDto? Initial { get; set; }
    [Parameter] public string SubmitLabel { get; set; } = "Submit Organization Change";
    [Parameter] public EventCallback<OrganizationChangeDto> OnSubmit { get; set; }

    private MudForm? _form;
    private bool _prefilled;
    private bool _lookupsReady;

    // Is current Sub list empty?
    private bool _subListAny => FilteredSubs().Any();

    // When org changes, clear invalid sub
    private void OnOrgChanged()
    {
        // _vm.Organization already updated by @bind
        if (_vm.SubOrganization is not null && !IsSubValidForOrg(_vm.SubOrganization, _vm.Organization))
            _vm.SubOrganization = null;

        StateHasChanged();
    }

    // Sub list: match selected org OR null org
    private IEnumerable<SubOrganization> FilteredSubs()
    {
        var oid = _vm.Organization?.Id;
        return SubOrganizations.Where(s => s.OrganizationId == oid || s.OrganizationId == null);
    }

    private static bool IsSubValidForOrg(SubOrganization s, Organization? org)
        => s.OrganizationId == org?.Id || s.OrganizationId == null;

    // Use filtered source for Sub-Org search
    

    private sealed class Vm
    {
        public Employees? Employee { get; set; }
        public DateTime? EffectiveDateDt { get; set; }
        public string? SubmitterComment { get; set; }

        public Employees? Manager { get; set; }
        public Employees? Supervisor { get; set; }
        public Organization? Organization { get; set; }
        public SubOrganization? SubOrganization { get; set; }
        public Employer? Employer { get; set; }
        public Site? Site { get; set; }

        public bool? IsActive { get; set; }
        public bool? IsLoa { get; set; }
        public bool? IsIntLoa { get; set; }
        public bool? IsRemote { get; set; }
    }
    private readonly Vm _vm = new();

    protected override void OnParametersSet()
    {
        _lookupsReady = Employees.Any() && Organizations.Any() && Employers.Any();

        if (!_lookupsReady || _prefilled || Initial is null) return;

        _vm.Employee = Employees.FirstOrDefault(e => e.Id == Initial.EmployeeId);
        _vm.EffectiveDateDt = Initial.EffectiveDate.ToDateTime(TimeOnly.MinValue);
        _vm.SubmitterComment = Initial.SubmitterComment;

        if (Initial.ManagerId is int mid)
            _vm.Manager = ManagerEmployees.FirstOrDefault(e => e.Id == mid);
        if (Initial.SupervisorId is int sid)
            _vm.Supervisor = SupervisorEmployees.FirstOrDefault(e => e.Id == sid);

        _vm.Organization = Organizations.FirstOrDefault(o => o.Id == Initial.OrganizationId);
        _vm.SubOrganization = SubOrganizations.FirstOrDefault(o => o.Id == Initial.SubOrganizationId);
        _vm.Employer = Employers.FirstOrDefault(o => o.Id == Initial.EmployerId);
        _vm.Site = Sites.FirstOrDefault(s => s.Id == Initial.SiteId);

        _vm.IsActive = Initial.IsActive;
        _vm.IsLoa = Initial.IsLoa;
        _vm.IsIntLoa = Initial.IsIntLoa;
        _vm.IsRemote = Initial.IsRemote;

        _prefilled = true;
    }

    // --- Label / Search helpers ---
    private static string EmpLabel(Employees? e) => e is null ? "" : $"{e.LastName}, {e.FirstName} ({e.Id})";
    private static string OrgLabel(Organization? o) => o?.Name ?? "";
    private static string SubOrgLabel(SubOrganization? so) => so?.Name ?? "";
    private static string EmployerLabel(Employer? e) => e?.Name ?? "";
    private static string SiteLabel(Site? s) => s is null ? "" : $"{s.SiteCode} - {s.Location}";

    private Task<IEnumerable<Employees>> SearchEmployees(string v, CancellationToken _)
        => Task.FromResult(Employees.Where(e => EmpLabel(e).Contains(v ?? "", StringComparison.OrdinalIgnoreCase)));
    private Task<IEnumerable<Employees>> SearchManagers(string v, CancellationToken _)
        => Task.FromResult(ManagerEmployees.Where(e => EmpLabel(e).Contains(v ?? "", StringComparison.OrdinalIgnoreCase)));
    private Task<IEnumerable<Employees>> SearchSupervisors(string v, CancellationToken _)
        => Task.FromResult(SupervisorEmployees.Where(e => EmpLabel(e).Contains(v ?? "", StringComparison.OrdinalIgnoreCase)));
    private Task<IEnumerable<Organization>> SearchOrganizations(string v, CancellationToken _)
        => Task.FromResult(Organizations.Where(o => (o.Name ?? "").Contains(v ?? "", StringComparison.OrdinalIgnoreCase)));
    private Task<IEnumerable<SubOrganization>> SearchSubOrganizations(string v, CancellationToken _)
    {
        var q = (v ?? string.Empty).Trim();
        var data = FilteredSubs();
        if (!string.IsNullOrWhiteSpace(q))
            data = data.Where(so => (so.Name ?? "").Contains(q, StringComparison.OrdinalIgnoreCase));
        return Task.FromResult(data);
    }
    private Task<IEnumerable<Employer>> SearchEmployers(string v, CancellationToken _)
        => Task.FromResult(Employers.Where(e => (e.Name ?? "").Contains(v ?? "", StringComparison.OrdinalIgnoreCase)));
    private Task<IEnumerable<Site>> SearchSites(string v, CancellationToken _)
        => Task.FromResult(Sites.Where(s =>
            (s.SiteCode ?? "").Contains(v ?? "", StringComparison.OrdinalIgnoreCase) ||
            (s.Location ?? "").Contains(v ?? "", StringComparison.OrdinalIgnoreCase)));

    // --- Submit ---
    private async Task SubmitClicked()
    {
        if (_form is not null)
        {
            await _form.Validate();
            if (!_form.IsValid) return;
        }
        await HandleSubmit();
    }

    private async Task HandleSubmit()
    {
        if (_vm.EffectiveDateDt is null || _vm.Employee is null) return;

        var dto = new OrganizationChangeDto(
            EmployeeId: _vm.Employee.Id,
            EffectiveDate: DateOnly.FromDateTime(_vm.EffectiveDateDt.Value),
            SubmitterComment: string.IsNullOrWhiteSpace(_vm.SubmitterComment) ? null : _vm.SubmitterComment.Trim(),
            ManagerId: _vm.Manager?.Id,
            SupervisorId: _vm.Supervisor?.Id,
            OrganizationId: _vm.Organization?.Id,
            SubOrganizationId: _vm.SubOrganization?.Id,
            EmployerId: _vm.Employer?.Id,
            SiteId: _vm.Site?.Id,
            IsActive: _vm.IsActive,
            IsLoa: _vm.IsLoa,
            IsIntLoa: _vm.IsIntLoa,
            IsRemote: _vm.IsRemote
        );

        await OnSubmit.InvokeAsync(dto);
    }
}
