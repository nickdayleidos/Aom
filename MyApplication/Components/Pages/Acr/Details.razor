@page "/acr/{Id:int}"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using Microsoft.AspNetCore.Components.Authorization
@inject IAcrQueryService Query
@inject IAcrService Acr
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthState

<MudPaper Class="pa-2" Outlined="true">
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.subtitle2">Time display</MudText>
        <MudSelect T="TimeDisplayMode" Dense @bind-Value="_mode">
            <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (employee site)</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern</MudSelectItem>
            <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain</MudSelectItem>
        </MudSelect>
    </MudStack>
</MudPaper>

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined>
        @if (_vm is null)
        {
            <MudProgressLinear Indeterminate />
        }
        else
        {
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h5">ACR #@_vm.AcrRequestId — @_vm.EmployeeName</MudText>
                <MudChip T="string" Color="Color.Primary">@_vm.TypeKey.ToString()</MudChip>
                @if (!string.IsNullOrWhiteSpace(_statusName))
                {
                    <MudChip T="string" Color="Color.Info">@_statusName</MudChip>
                }

                <MudSpacer />

                @if (ShowAnyButtons)
                {
                    <MudStack Row Spacing="1">
                        @* Full workflow (Org/Sched/OrgSched/OT) *@
                        @if (IsApprovalFlow)
                        {
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Disabled="@(!_canManagerApprove)"
                                       OnClick="ManagerApproveAsync">
                                Manager Approve
                            </MudButton>

                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Disabled="@(!_canWfmApprove)"
                                       OnClick="WfmApproveAsync">
                                WFM Approve
                            </MudButton>

                            <MudButton Variant="Variant.Text"
                                       Color="Color.Error"
                                       Disabled="@(!_canReject)"
                                       OnClick="RejectAsync">
                                Reject
                            </MudButton>
                        }

                        @* Cancel is allowed for both approval-flow types AND Rehire/Separation *@
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Secondary"
                                   Disabled="@(!_canCancel)"
                                   OnClick="CancelAsync">
                            Cancel
                        </MudButton>
                    </MudStack>
                }

                @if (_canEdit)
                {
                    <MudButton Variant="Variant.Text"
                               OnClick="@(() => Nav.NavigateTo($"/acr/{Id}/edit"))">
                        Edit
                    </MudButton>
                }
            </MudStack>

            <MudDivider Class="my-2" />

            <MudGrid>
                @if (_vm.TypeKey == AcrTypeKey.NewHire)
                {
                    @* New Hire: no previous details *@
                    <MudItem xs="12" md="12">
                        <AcrFormHost Value="@_mirror"
                                     ValueChanged="@(_ => {})"
                                     ReadOnly="true"
                                     ForceShowOrg="@(_vm.Organization is not null)"
                                     ForceShowSchedule="@(_vm.Schedule is not null)"
                                     ForceShowOvertimeOnly="@(_vm.TypeKey == AcrTypeKey.OvertimeAdjustment)"
                                     Mode="_mode" />
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12" md="5">
                        <PreviousDetails Value="@_mirror"
                                         EmployeeId="@_vm.EmployeeId"
                                         ShowOrg="@(_vm.Organization is not null)"
                                         ShowSchedule="@(_vm.Schedule is not null)"
                                         ShowOvertime="@((_vm.Overtime is not null) ||
                                                                                                  (_vm.Schedule?.IsOtAdjustment ?? false))"
                                 Mode="_mode" />
            </MudItem>

                    <MudItem xs="12" md="7">
                        <AcrFormHost Value="@_mirror"
                                     ValueChanged="@(_ => {})"
                                     ReadOnly="true"
                                     ForceShowOrg="@(_vm.Organization is not null)"
                                     ForceShowSchedule="@(_vm.Schedule is not null)"
                                     ForceShowOvertimeOnly="@(_vm.TypeKey == AcrTypeKey.OvertimeAdjustment)"
                                     Mode="_mode" />
                    </MudItem>
                        }
            </MudGrid>
        }
    </MudPaper>
</MudStack>

@code {
    [Parameter] public int Id { get; set; }

    private const int StatusSubmitted = 1;
    private const int StatusManagerApproved = 2;
    private const int StatusWfmApproved = 3;
    private const int StatusProcessed = 4;
    private const int StatusCancelled = 5;
    private const int StatusRejected = 6;

    private AcrDetailsVm? _vm;
    private AcrCreateVm? _mirror;
    private string? _statusName;
    private int? _statusId;
    private string? _siteWindowsTz;
    private NewHireDto? _newHire;

    // Roles
    private bool _isAdmin;
    private bool _isWfm;
    private bool _isManager;
    private bool _isSupervisor;

    private TimeDisplayMode _modeBacking = TimeDisplayMode.EmployeeLocal;
    private TimeDisplayMode _mode
    {
        get => _modeBacking;
        set
        {
            if (_modeBacking == value)
                return;
            _modeBacking = value;

            if (_vm is not null)
                _mirror = ToCreateMirror(_vm);
        }
    }

    // ----- button visibility / rules -------------------------

    // Any type that has *some* buttons
    private bool ShowAnyButtons =>
        _vm is not null && _statusId.HasValue &&
        (_vm.TypeKey is AcrTypeKey.OrganizationChange
                     or AcrTypeKey.ScheduleChange
                     or AcrTypeKey.OrgSchedule
                     or AcrTypeKey.OvertimeAdjustment
                     or AcrTypeKey.Rehire
                     or AcrTypeKey.Separation);

    // Types that participate in the Manager/WFM/Reject workflow
    private bool IsApprovalFlow =>
        _vm is not null &&
        (_vm.TypeKey is AcrTypeKey.OrganizationChange
                     or AcrTypeKey.ScheduleChange
                     or AcrTypeKey.OrgSchedule
                     or AcrTypeKey.OvertimeAdjustment);

    private bool _canManagerApprove =>
        IsApprovalFlow &&
        _statusId == StatusSubmitted &&
        (_isAdmin || _isWfm || _isManager);

    private bool _canWfmApprove =>
        IsApprovalFlow &&
        _statusId == StatusManagerApproved &&
        (_isAdmin || _isWfm);

    private bool _canReject =>
        IsApprovalFlow &&
        (_statusId == StatusSubmitted || _statusId == StatusManagerApproved) &&
        (_isAdmin || _isWfm || _isManager);

    private bool _canCancel =>
        ShowAnyButtons &&
        (_statusId == StatusSubmitted
         || _statusId == StatusManagerApproved
         || _statusId == StatusWfmApproved
         || _statusId == StatusProcessed) &&
        (_isAdmin || _isWfm || _isManager);

    private bool _canEdit
    {
        get
        {
            if (!_statusId.HasValue) return false;
            if (_statusId == StatusSubmitted)
            {
                // Admin, WFM, Manager, Supervisor
                return _isAdmin || _isWfm || _isManager || _isSupervisor;
            }
            // Other statuses: only WFM and Admin
            return _isAdmin || _isWfm;
        }
    }

    // --------------------------------------------------------

    protected override async Task OnParametersSetAsync()
    {
        // 1. Get User Roles
        var authState = await AuthState.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdmin = user.IsInRole("Admin");
        _isWfm = user.IsInRole("WFM");
        _isManager = user.IsInRole("Manager");
        _isSupervisor = user.IsInRole("Supervisor");

        // 2. Load Data
        _vm = await Query.LoadDetailsAsync(Id);
        _statusName = await Query.GetStatusNameByAcrIdAsync(Id);
        _statusId = await Query.GetStatusIdByAcrIdAsync(Id);

        // For New Hire, hydrate from Employees
        if (_vm is not null && _vm.TypeKey == AcrTypeKey.NewHire)
        {
            var emp = await Query.GetEmployeeAsync(_vm.EmployeeId);
            if (emp is not null)
            {
                _newHire = new NewHireDto(
                    emp.FirstName,
                    emp.LastName,
                    emp.MiddleInitial,
                    emp.NmciEmail,
                    emp.UsnOperatorId,
                    emp.UsnAdminId,
                    emp.CorporateEmail,
                    emp.CorporateId,
                    emp.DomainLoginName
                );
            }
        }

        _siteWindowsTz = await ResolveSiteWindowsTzAsync();
        _mirror = ToCreateMirror(_vm!);
    }

    private async Task<string?> ResolveSiteWindowsTzAsync()
    {
        if (_vm?.Organization?.SiteId is int siteId1)
        {
            var tz = await Query.GetSiteTimeZoneAsync(siteId1);
            if (!string.IsNullOrWhiteSpace(tz))
                return tz!;
        }

        if (_vm?.EmployeeId is int empId)
        {
            var prev = await Query.GetPrevDetailsAsync(empId, TimeDisplayMode.Eastern);
            if (prev?.SiteId is int siteId2)
            {
                var tz = await Query.GetSiteTimeZoneAsync(siteId2);
                if (!string.IsNullOrWhiteSpace(tz))
                    return tz!;
            }
        }

        return "Eastern Standard Time";
    }

    private TimeOnly? ConvertFromEt(TimeOnly? et)
    {
        if (et is null) return null;
        if (_mode == TimeDisplayMode.Eastern) return et;

        var easternTz = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
        var targetTzId = _mode switch
        {
            TimeDisplayMode.EmployeeLocal => string.IsNullOrWhiteSpace(_siteWindowsTz)
                ? "Eastern Standard Time"
                : _siteWindowsTz!,
            TimeDisplayMode.Mountain => "Mountain Standard Time",
            _ => "Eastern Standard Time"
        };
        var targetTz = TimeZoneInfo.FindSystemTimeZoneById(targetTzId);

        var dtEt = new DateTime(2000, 1, 1, et.Value.Hour, et.Value.Minute, 0, DateTimeKind.Unspecified);
        var dtUtc = TimeZoneInfo.ConvertTimeToUtc(dtEt, easternTz);
        var dtLocal = TimeZoneInfo.ConvertTimeFromUtc(dtUtc, targetTz);

        return new TimeOnly(dtLocal.Hour, dtLocal.Minute);
    }

    private AcrCreateVm ToCreateMirror(AcrDetailsVm d)
    {
        ScheduleChangeDto? schedule = d.Schedule;
        if (schedule is not null)
        {
            schedule = schedule with
            {
                MondayStart = ConvertFromEt(schedule.MondayStart),
                MondayEnd = ConvertFromEt(schedule.MondayEnd),
                TuesdayStart = ConvertFromEt(schedule.TuesdayStart),
                TuesdayEnd = ConvertFromEt(schedule.TuesdayEnd),
                WednesdayStart = ConvertFromEt(schedule.WednesdayStart),
                WednesdayEnd = ConvertFromEt(schedule.WednesdayEnd),
                ThursdayStart = ConvertFromEt(schedule.ThursdayStart),
                ThursdayEnd = ConvertFromEt(schedule.ThursdayEnd),
                FridayStart = ConvertFromEt(schedule.FridayStart),
                FridayEnd = ConvertFromEt(schedule.FridayEnd),
                SaturdayStart = ConvertFromEt(schedule.SaturdayStart),
                SaturdayEnd = ConvertFromEt(schedule.SaturdayEnd),
                SundayStart = ConvertFromEt(schedule.SundayStart),
                SundayEnd = ConvertFromEt(schedule.SundayEnd)
            };
        }

        return new AcrCreateVm
        {
            EmployeeId = d.EmployeeId,
            TypeId = (int)d.TypeKey,
            EffectiveDate = d.EffectiveDate,
            IncludeOvertimeAdjustment = (d.Schedule?.IsOtAdjustment ?? false) ||
                                        (d.Overtime is not null),
            Organization = d.Organization,
            Schedule = schedule,
            Overtime = d.Overtime,
            NewHire = _newHire
        };
    }

    // --- Button handlers -------------------------------------------------

    private async Task RefreshStatusAsync()
    {
        _statusId = await Query.GetStatusIdByAcrIdAsync(Id);
        _statusName = await Query.GetStatusNameByAcrIdAsync(Id);
        StateHasChanged();
    }

    private async Task ManagerApproveAsync()
    {
        await Acr.SetStatusAsync(Id, StatusManagerApproved);
        Snackbar.Add("ACR manager-approved.", Severity.Success);
        await RefreshStatusAsync();
    }

    private async Task WfmApproveAsync()
    {
        await Acr.SetStatusAsync(Id, StatusWfmApproved);
        Snackbar.Add("ACR WFM-approved.", Severity.Success);
        await RefreshStatusAsync();
    }

    private async Task RejectAsync()
    {
        await Acr.SetStatusAsync(Id, StatusRejected);
        Snackbar.Add("ACR rejected.", Severity.Warning);
        await RefreshStatusAsync();
    }

    private async Task CancelAsync()
    {
        await Acr.SetStatusAsync(Id, StatusCancelled);
        Snackbar.Add("ACR cancelled.", Severity.Info);
        await RefreshStatusAsync();
    }
}