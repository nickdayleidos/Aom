@page "/opera"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using MyApplication.Components.Model.AOM.Employee
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using MyApplication.Common.Time
@using MyApplication.Components.Service
@using Microsoft.AspNetCore.Components.Authorization

@inject IOperaRepository Repo
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject UserProfileService UserProfile
@inject AuthenticationStateProvider AuthStateProvider

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined="true">
        
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">Opera Requests</MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="GoSubmit">
                New Request
            </MudButton>
        </MudStack>

        <MudDivider Class="my-3" />

        <MudGrid Spacing="2" Class="mt-2" AlignItems="Center">
            
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_filterText" 
                              Placeholder="Search (Name, ID)..." 
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense"
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              Clearable="true"/>
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="OperaStatus"
                                 Label="Status"
                                 Dense="true"
                                 Clearable="true"
                                 Value="_selectedStatusObj"
                                 ValueChanged="OnStatusObjChanged"
                                 SearchFunc="SearchStatuses"
                                 ToStringFunc="@(s => s?.Name)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string>?"
                                 Label="Manager"
                                 Dense="true"
                                 Clearable="true"
                                 Value="_selectedManagerKv"
                                 ValueChanged="OnManagerKvChanged"
                                 SearchFunc="SearchManagers"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string>?"
                                 Label="Supervisor"
                                 Dense="true"
                                 Clearable="true"
                                 Value="_selectedSupervisorKv"
                                 ValueChanged="OnSupervisorKvChanged"
                                 SearchFunc="SearchSupervisors"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudDateRangePicker @bind-DateRange="_range" Label="Date Range (ET)" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="TimeDisplayMode" @bind-Value="_displayMode" Label="Time Zone Display" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (Employee Site)</MudSelectItem>
                    <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern (ET)</MudSelectItem>
                    <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain (MT)</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="9" Class="d-flex align-center justify-end gap-2">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Secondary" 
                           OnClick="ClearFilters"
                           StartIcon="@Icons.Material.Outlined.FilterAltOff">
                    Reset
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="Reload" 
                           StartIcon="@Icons.Material.Outlined.Search">
                    Search
                </MudButton>
            </MudItem>

        </MudGrid>
    </MudPaper>

    <MudTabs @bind-ActivePanelIndex="_activeTab" Rounded="true" Elevation="0" Color="Color.Transparent" Class="mt-2">
        <MudTabPanel Text="All Requests" Icon="@Icons.Material.Outlined.List">@TableBlock(AllItems)</MudTabPanel>
        <MudTabPanel Text="Pending (Past)" Icon="@Icons.Material.Outlined.History">@TableBlock(PendingPastItems)</MudTabPanel>
        <MudTabPanel Text="Pending (Today)" Icon="@Icons.Material.Outlined.Today">@TableBlock(PendingTodayItems)</MudTabPanel>
        <MudTabPanel Text="Pending (Future)" Icon="@Icons.Material.Outlined.Event">@TableBlock(PendingFutureItems)</MudTabPanel>
        <MudTabPanel Text="Approved (Today)" Icon="@Icons.Material.Outlined.CheckCircle">@TableBlock(TodaysApprovedItems)</MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    private List<OperaRequest> _items = new();
    private Dictionary<int, string> _types = new();
    private Dictionary<int, string> _subTypes = new();
    private Dictionary<int, string?> _employeeSiteTz = new();

    // Lookup Data
    private List<OperaStatus> _statuses = new();
    private List<KeyValuePair<int, string>> _managers = new();
    private List<KeyValuePair<int, string>> _supervisors = new();

    // Bound Objects
    private OperaStatus? _selectedStatusObj;
    private KeyValuePair<int, string>? _selectedManagerKv;
    private KeyValuePair<int, string>? _selectedSupervisorKv;

    // Derived IDs
    private int? _statusId => _selectedStatusObj?.Id;
    private int? _managerId => _selectedManagerKv?.Key;
    private int? _supervisorId => _selectedSupervisorKv?.Key;

    private string? _filterText;
    private DateRange? _range;
    private int _activeTab;

    private const int SubmittedStatusId = 1;
    private const int ApprovedStatusId = 2;
    private const int ProcessedStatusId = 3;
    private const int CancelledStatusId = 4;
    private const int RejectedStatusId = 5;

    private enum StatusAction { Approve, Reject, Cancel }

    private TimeDisplayMode _displayMode = TimeDisplayMode.EmployeeLocal;
    private string DisplayTzLabel => _displayMode switch
    {
        TimeDisplayMode.Eastern => "Eastern (ET)",
        TimeDisplayMode.Mountain => "Mountain (MT)",
        TimeDisplayMode.EmployeeLocal => "Local (employee site)",
        _ => "Local (employee site)"
    };

    private DateTime _todayEt;
    private DateTime _todayMt;

    // Roles
    private bool _isAdmin;
    private bool _isWfm;
    private bool _isOst;
    private bool _isManager;
    private bool _isSupervisor;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdmin = user.IsInRole("Admin");
        _isWfm = user.IsInRole("WFM");
        _isOst = user.IsInRole("OST");
        _isManager = user.IsInRole("Manager");
        _isSupervisor = user.IsInRole("Supervisor");

        try 
        {
            var tStatus = Repo.GetStatusesAsync();
            var tTypes = Repo.GetActivityTypesAsync();
            var tSubTypes = Repo.GetActivitySubTypesAsync();
            var tManagers = Repo.GetManagersAsync();       
            var tSupervisors = Repo.GetSupervisorsAsync(); 

            await Task.WhenAll(tStatus, tTypes, tSubTypes, tManagers, tSupervisors);

            _statuses = (await tStatus).ToList();
            _types = await tTypes;
            _subTypes = await tSubTypes;
            _managers = await tManagers;
            _supervisors = await tSupervisors;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading lookups: {ex.Message}", Severity.Error);
        }

        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        DateTime? fromEt = null, toEt = null;
        if (_range?.Start is DateTime s) fromEt = s.Date;
        if (_range?.End is DateTime e) toEt = e.Date.AddDays(1);

        var q = new OperaQuery
        {
            NameOrId = _filterText,
            StatusId = _statusId,
            ManagerId = _managerId,       
            SupervisorId = _supervisorId, 
            FromUtc = fromEt,
            ToUtc = toEt,
            Take = 1000
        };

        try 
        {
            var (items, _) = await Repo.SearchAsync(q);
            _items = items.ToList();

            var nowUtc = DateTime.UtcNow;
            _todayEt = TimeZoneInfo.ConvertTimeFromUtc(nowUtc, Et.Zone).Date;
            _todayMt = TimeZoneInfo.ConvertTimeFromUtc(nowUtc, Mt.Zone).Date;

            await LoadEmployeeSiteTimezonesAsync();
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Error searching: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEmployeeSiteTimezonesAsync()
    {
        _employeeSiteTz.Clear();
        var empIds = _items.Select(i => i.EmployeeId).Distinct().ToList();
        if (empIds.Count == 0) return;

        _employeeSiteTz = await Repo.GetEmployeeSiteTimeZonesAsync(empIds);
    }

    private Task Reload() => LoadAsync();
    
    private void ClearFilters()
    {
        _filterText = null;
        _selectedStatusObj = null;
        _selectedManagerKv = null;
        _selectedSupervisorKv = null;
        _range = null;
        Reload();
    }

    private void GoSubmit() => Nav.NavigateTo("/opera/new");

    // --- Search Helpers ---

    private Task<IEnumerable<OperaStatus>> SearchStatuses(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value)) return Task.FromResult<IEnumerable<OperaStatus>>(_statuses);
        return Task.FromResult(_statuses.Where(x => x.Name.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchManagers(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value)) 
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_managers.Select(x => (KeyValuePair<int, string>?)x));

        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _managers.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                     .Select(x => (KeyValuePair<int, string>?)x));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchSupervisors(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value)) 
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_supervisors.Select(x => (KeyValuePair<int, string>?)x));

        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _supervisors.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                        .Select(x => (KeyValuePair<int, string>?)x));
    }

    // --- Binding Handlers ---
    private void OnStatusObjChanged(OperaStatus? val) { _selectedStatusObj = val; } // Note: Change doesn't trigger reload here, user clicks "Search" button
    private void OnManagerKvChanged(KeyValuePair<int, string>? val) { _selectedManagerKv = val; }
    private void OnSupervisorKvChanged(KeyValuePair<int, string>? val) { _selectedSupervisorKv = val; }

    // ---------- Helpers for Sorting ----------

    private object SortByEmployee(OperaRequest x)
    {
        if (x.Employees != null)
            return $"{x.Employees.LastName}, {x.Employees.FirstName}{(!string.IsNullOrEmpty(x.Employees.MiddleInitial) ? " " + x.Employees.MiddleInitial : "")}";
        return string.Empty;
    }

    private object SortByType(OperaRequest x)
    {
        if (_types.TryGetValue(x.ActivityTypeId, out var tName))
            return tName;
        return string.Empty;
    }

    // ---------- helpers for display time & status ----------

    private DateTime ToDisplayTime(DateTime etStored, int employeeId)
    {
        string? tzId = _displayMode switch
        {
            TimeDisplayMode.Eastern => "Eastern Standard Time",
            TimeDisplayMode.Mountain => "Mountain Standard Time",
            TimeDisplayMode.EmployeeLocal => GetEmployeeSiteTz(employeeId),
            _ => GetEmployeeSiteTz(employeeId)
        };
        return Tz.FromEtToSite(etStored, tzId);
    }

    private string? GetEmployeeSiteTz(int employeeId)
    {
        if (_employeeSiteTz.TryGetValue(employeeId, out var tz)) return tz;
        return null;
    }

    private static int? GetStatusId(OperaRequest r) => r.OperaStatusId;

    // ---------- Logic for Permissions ----------

    private bool IsPendingPastOrFuture(OperaRequest r)
    {
        if (GetStatusId(r) != SubmittedStatusId) return false;
        return !IsTodayInEtOrMt(r.StartTime);
    }

    private bool CanOpen(OperaRequest r)
    {
        if (IsPendingPastOrFuture(r)) return _isAdmin || _isWfm;
        return true;
    }

    private bool CanApprove(OperaRequest r)
    {
        if (GetStatusId(r) != SubmittedStatusId) return false;
        if (IsPendingPastOrFuture(r)) return _isAdmin || _isWfm;
        return _isOst || _isWfm || _isAdmin;
    }

    private bool CanReject(OperaRequest r) => CanApprove(r);

    private bool CanCancel(OperaRequest r)
    {
        var s = GetStatusId(r);
        if (s != SubmittedStatusId && s != ApprovedStatusId && s != ProcessedStatusId) return false;
        if (IsPendingPastOrFuture(r)) return _isAdmin || _isWfm;
        return true;
    }

    // ---------- tab-specific views ----------
    private IEnumerable<OperaRequest> AllItems => _items;

    private bool IsTodayInEtOrMt(DateTime etStored)
    {
        var etDate = etStored.Date;
        var mtDate = Et.ToMt(etStored).Date;
        return etDate == _todayEt || mtDate == _todayMt;
    }

    private IEnumerable<OperaRequest> PendingPastItems =>
        _items.Where(r =>
        {
            if (GetStatusId(r) != SubmittedStatusId) return false;
            var etDate = r.StartTime.Date;
            var mtDate = Et.ToMt(r.StartTime).Date;
            return etDate < _todayEt && mtDate < _todayMt;
        });

    private IEnumerable<OperaRequest> PendingTodayItems =>
        _items.Where(r => GetStatusId(r) == SubmittedStatusId && IsTodayInEtOrMt(r.StartTime));

    private IEnumerable<OperaRequest> PendingFutureItems =>
        _items.Where(r =>
        {
            if (GetStatusId(r) != SubmittedStatusId) return false;
            var etDate = r.StartTime.Date;
            var mtDate = Et.ToMt(r.StartTime).Date;
            return etDate > _todayEt && mtDate > _todayMt;
        });

    private IEnumerable<OperaRequest> TodaysApprovedItems =>
        _items.Where(r =>
        {
            var s = GetStatusId(r);
            if (s != ApprovedStatusId && s != ProcessedStatusId) return false;
            return IsTodayInEtOrMt(r.StartTime);
        });

    // ---------- status update ----------
    private async Task SetStatusAsync(OperaRequest req, StatusAction action)
    {
        if (req is null) return;
        string keyword = action switch
        {
            StatusAction.Approve => "Approv",
            StatusAction.Reject => "Reject",
            StatusAction.Cancel => "Cancel",
            _ => ""
        };

        var status = _statuses.FirstOrDefault(
            s => s.Name.Contains(keyword, StringComparison.OrdinalIgnoreCase));

        if (status is null)
        {
            Snackbar.Add($"Status for '{action}' not found.", Severity.Error);
            return;
        }

        var profile = await UserProfile.GetAsync();
        var actor = profile.UserName;

        await Repo.SetStatusAsync(req.RequestId, status.Id, actor);

        Snackbar.Add($"Request #{req.RequestId} set to {status.Name}.", Severity.Success);
        await LoadAsync();
    }

    // ---------- shared table render fragment ----------
    RenderFragment TableBlock(IEnumerable<OperaRequest> items) => @<MudPaper Class="pa-0 mt-2" Outlined="true">
        <MudStack Spacing="1" Class="pa-2 pb-0">
            <MudText Typo="Typo.caption" Class="opacity-75">Times shown in: <b>@DisplayTzLabel</b></MudText>
        </MudStack>
        <MudTable T="OperaRequest" Items="items" Hover="true" Dense="true" Striped="true" Elevation="0">
            <HeaderContent>
                <MudTh><MudTableSortLabel T="OperaRequest" SortBy="new Func<OperaRequest, object>(x => x.RequestId)">ID</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="OperaRequest" SortBy="SortByEmployee">Employee</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="OperaRequest" SortBy="new Func<OperaRequest, object>(x => ToDisplayTime(x.StartTime, x.EmployeeId))">Start</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="OperaRequest" SortBy="new Func<OperaRequest, object>(x => ToDisplayTime(x.EndTime, x.EmployeeId))">End</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="OperaRequest" SortBy="SortByType">Type / SubType</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="OperaRequest" SortBy="new Func<OperaRequest, object>(x => GetStatusId(x))">Status</MudTableSortLabel></MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="OperaId">@context.RequestId</MudTd>
                <MudTd DataLabel="Employee">@($"{context.Employees?.LastName}, {context.Employees?.FirstName} (#{context.EmployeeId})")</MudTd>
                <MudTd DataLabel="Start">@ToDisplayTime(context.StartTime, context.EmployeeId).ToString("MM/dd HH:mm")</MudTd>
                <MudTd DataLabel="End">@ToDisplayTime(context.EndTime, context.EmployeeId).ToString("MM/dd HH:mm")</MudTd>
                <MudTd DataLabel="Type/SubType">
                    @(_types.TryGetValue(context.ActivityTypeId, out var tName) ? tName : "") /
                    @(_subTypes.TryGetValue(context.ActivitySubTypeId, out var stName) ? stName : "")
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="int" Size="Size.Small" Variant="Variant.Text" Color="Color.Default">
                        @_statuses.FirstOrDefault(s => s.Id == GetStatusId(context))?.Name
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true">
                        <MudMenuItem OnClick="@(() => Nav.NavigateTo($"/opera/{context.RequestId}"))" Disabled="@(!CanOpen(context))">Open</MudMenuItem>
                        <MudMenuItem OnClick="@(() => SetStatusAsync(context, StatusAction.Approve))" Disabled="@(!CanApprove(context))">Approve</MudMenuItem>
                        <MudMenuItem OnClick="@(() => SetStatusAsync(context, StatusAction.Reject))" Disabled="@(!CanReject(context))">Reject</MudMenuItem>
                        <MudMenuItem OnClick="@(() => SetStatusAsync(context, StatusAction.Cancel))" Disabled="@(!CanCancel(context))">Cancel</MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4 text-center">No requests found matching these filters.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 200 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>;
}