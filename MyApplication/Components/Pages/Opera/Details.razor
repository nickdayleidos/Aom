@page "/opera/{RequestId:int}"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using MyApplication.Components.Model.AOM.Employee
@using MyApplication.Common.Time
@using MyApplication.Components.Service
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject IOperaRepository Repo
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject UserProfileService UserProfile
@inject AuthenticationStateProvider AuthStateProvider

<MudStack Spacing="4">
    <MudPaper Class="pa-4" Outlined="true">
        <MudGrid AlignItems="AlignItems.Center">
            <MudItem xs="12" md="5">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Nav.NavigateTo("/opera"))" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.h5">Opera Request #@RequestId</MudText>
                        @if (_item != null)
                        {
                            <MudText Typo="Typo.body2">@_item.Employees?.LastName, @_item.Employees?.FirstName</MudText>
                        }
                    </MudStack>
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="7" Class="d-flex justify-end gap-2 align-center">

                <MudSelect T="TimeDisplayMode"
                           @bind-Value="_mode"
                           Label="Time Display"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Dense="true"
                           Disabled="@_isEditing"
                           Style="min-width: 160px;">
                    <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (Site)</MudSelectItem>
                    <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern (ET)</MudSelectItem>
                    <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain (MT)</MudSelectItem>
                </MudSelect>

                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />

                @if (_isEditing)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveAsync">Save</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CancelEdit">Cancel</MudButton>
                }
                else if (_item != null)
                {
                    @* --- ACTION BUTTONS --- *@

                    @* Actions available if NOT Cancelled/Rejected? Or maybe only active? 
                       For now, keeping actions for 1/6, but EDIT is open to all. *@
                    @if (_item.OperaStatusId == 1 || _item.OperaStatusId == 6)
                    {
                        <MudTooltip Text="Approve">
                            <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" OnClick="@(() => SetStatusAsync(2))" />
                        </MudTooltip>
                        <MudTooltip Text="Reject">
                            <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" OnClick="@(() => SetStatusAsync(5))" />
                        </MudTooltip>

                        @* PENDING ACTION *@
                        @if (_isWfmOrAdmin && _item.OperaStatusId == 1)
                        {
                            <MudTooltip Text="Set Pending">
                                <MudIconButton Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning" OnClick="@(() => SetStatusAsync(6))" />
                            </MudTooltip>
                        }

                        <MudTooltip Text="Cancel Request">
                            <MudIconButton Icon="@Icons.Material.Filled.Block" Color="Color.Default" OnClick="@(() => SetStatusAsync(4))" />
                        </MudTooltip>
                    }

                    @* WFM / Admin Specific Actions *@
                    @if (_isWfmOrAdmin)
                    {
                        @if (_item.OperaStatusId == 2)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" OnClick="@(() => SetStatusAsync(1))">Unapprove</MudButton>
                        }
                    }

                    @* EDIT Button: Available to all authorized roles, resets status on save *@
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Edit" OnClick="StartEdit">Edit Request</MudButton>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* ... (Rest of UI same as before) ... *@
    @if (_item == null)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4 h-100" Outlined="true">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h6">Request Details</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-n2">
                            Times shown in: <b>@_mode</b>
                        </MudText>

                        <MudGrid>
                            <MudItem xs="6">
                                @if (_isEditing)
                                {
                                    <MudDatePicker Label="Start Date" @bind-Date="_editStartDate" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                    <MudTimePicker Label="Start Time" @bind-Time="_editStartTime" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mt-2" />
                                }
                                else
                                {
                                    <MudField Label="Start Time" Variant="Variant.Outlined">
                                        @ToDisplayTime(_item.StartTime).ToString("g")
                                    </MudField>
                                }
                            </MudItem>
                            <MudItem xs="6">
                                @if (_isEditing)
                                {
                                    <MudDatePicker Label="End Date" @bind-Date="_editEndDate" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                    <MudTimePicker Label="End Time" @bind-Time="_editEndTime" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mt-2" />
                                }
                                else
                                {
                                    <MudField Label="End Time" Variant="Variant.Outlined">
                                        @ToDisplayTime(_item.EndTime).ToString("g")
                                    </MudField>
                                }
                            </MudItem>
                        </MudGrid>

                        <MudGrid>
                            <MudItem xs="6">
                                @if (_isEditing)
                                {
                                    <MudSelect T="int" Label="Type" Value="_item.ActivityTypeId" ValueChanged="OnTypeChanged" Variant="Variant.Outlined" Margin="Margin.Dense">
                                        @foreach (var t in _types)
                                        {
                                            <MudSelectItem Value="@t.Key">@t.Value</MudSelectItem>
                                        }
                                    </MudSelect>
                                }
                                else
                                {
                                    <MudField Label="Activity Type" Variant="Variant.Outlined">@(_types.TryGetValue(_item.ActivityTypeId, out var t) ? t : _item.ActivityTypeId)</MudField>
                                }
                            </MudItem>
                            <MudItem xs="6">
                                @if (_isEditing)
                                {
                                    <MudSelect T="int" Label="SubType" @bind-Value="_item.ActivitySubTypeId" Variant="Variant.Outlined" Margin="Margin.Dense">
                                        @foreach (var st in _filteredSubTypes)
                                        {
                                            <MudSelectItem Value="@st.Key">@st.Value</MudSelectItem>
                                        }
                                    </MudSelect>
                                }
                                else
                                {
                                    <MudField Label="Activity SubType" Variant="Variant.Outlined">@(_subTypes.TryGetValue(_item.ActivitySubTypeId, out var s) ? s : _item.ActivitySubTypeId)</MudField>
                                }
                            </MudItem>
                        </MudGrid>

                        @if (_isEditing)
                        {
                            <MudTextField Label="Comments" @bind-Value="_item.SubmitterComments" Lines="3" Variant="Variant.Outlined" />
                        }
                        else
                        {
                            <MudField Label="Comments" Variant="Variant.Outlined" Lines="3">@_item.SubmitterComments</MudField>
                        }

                        <MudDivider />
                        <MudStack Row="true" Spacing="4">
                            <MudText Typo="Typo.caption"><b>Submitted:</b> @ToDisplayTime(_item.SubmitTime).ToString("g") by @_item.SubmittedBy</MudText>
                            @if (_item.LastUpdatedTime.HasValue)
                            {
                                <MudText Typo="Typo.caption"><b>Last Updated:</b> @ToDisplayTime(_item.LastUpdatedTime.Value).ToString("g") by @_item.LastUpdatedBy</MudText>
                            }
                        </MudStack>

                        @if (_item.ApproveTime.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Success"><b>Approved:</b> @ToDisplayTime(_item.ApproveTime.Value).ToString("g") by @_item.ApproveBy</MudText>
                        }
                        @if (_item.RejectedTime.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error"><b>Rejected:</b> @ToDisplayTime(_item.RejectedTime.Value).ToString("g") by @_item.RejectedBy</MudText>
                        }
                        @if (_item.CancelledTime.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Default"><b>Cancelled:</b> @ToDisplayTime(_item.CancelledTime.Value).ToString("g") by @_item.CancelledBy</MudText>
                        }

                    </MudStack>
                </MudPaper>
            </MudItem>

            @* Schedule Block *@
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4 h-100" Outlined="true">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h6">Weekly Schedule Context</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-n2">
                            Schedule for the week of the request (@_mode)
                        </MudText>

                        <MudTable Items="_schedule" Dense="true" Hover="true" FixedHeader="true" Height="400px" Striped="true">
                            <HeaderContent>
                                <MudTh>Date</MudTh>
                                <MudTh>Time</MudTh>
                                <MudTh>Activity</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="sch">
                                @{
                                    var displayStart = ToDisplayTime(sch.StartTime);
                                    var displayEnd = ToDisplayTime(sch.EndTime);
                                }
                                <MudTd>@displayStart.ToString("ddd MM/dd")</MudTd>
                                <MudTd>@displayStart.ToString("HH:mm") - @displayEnd.ToString("HH:mm")</MudTd>
                                <MudTd>
                                    <MudText Typo="Typo.body2">@sch.ActivityType?.Name</MudText>
                                    <MudText Typo="Typo.caption">@sch.ActivitySubType?.Name</MudText>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>No schedule found for this week.</NoRecordsContent>
                        </MudTable>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudStack>

@code {
    [Parameter] public int RequestId { get; set; }

    private OperaRequest? _item;
    private List<DetailedSchedule> _schedule = new();

    // Time Display State
    private TimeDisplayMode _mode = TimeDisplayMode.EmployeeLocal;
    private string? _employeeSiteTzId;

    // Lookups
    private Dictionary<int, string> _types = new();
    private Dictionary<int, string> _subTypes = new();
    private Dictionary<int, string> _filteredSubTypes = new();

    [Inject] MyApplication.Components.Data.AomDbContext Db { get; set; } = default!;

    // Edit State
    private bool _isEditing = false;
    private DateTime? _editStartDate;
    private TimeSpan? _editStartTime;
    private DateTime? _editEndDate;
    private TimeSpan? _editEndTime;

    // Permissions State
    private bool _isWfmOrAdmin = false;

    // Cache raw subtypes for filtering
    private List<ActivitySubType> _rawSubTypes = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isWfmOrAdmin = user.IsInRole("Admin") || user.IsInRole("WFM") || user.IsInRole("OST");

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _item = await Repo.GetAsync(RequestId);
        if (_item != null)
        {
            var timezones = await Repo.GetEmployeeSiteTimeZonesAsync(new[] { _item.EmployeeId });
            if (timezones.TryGetValue(_item.EmployeeId, out var tz))
            {
                _employeeSiteTzId = tz;
            }

            _types = await Repo.GetActivityTypesAsync();
            _rawSubTypes = await Db.ActivitySubTypes.AsNoTracking().Where(x => x.IsActive == true).ToListAsync();
            _subTypes = _rawSubTypes.ToDictionary(k => k.Id, v => v.Name);

            FilterSubTypes(_item.ActivityTypeId);

            var startOfWeek = DateOnly.FromDateTime(_item.StartTime.Date.AddDays(-(int)_item.StartTime.DayOfWeek));
            _schedule = await Repo.GetEmployeeWeeklyScheduleAsync(_item.EmployeeId, startOfWeek);
        }
    }

    // --- Status Actions ---

    private async Task SetStatusAsync(int statusId)
    {
        if (_item == null) return;

        var user = await UserProfile.GetAsync();
        var actor = user.UserName ?? "Unknown";

        try
        {
            await Repo.SetStatusAsync(_item.RequestId, statusId, actor);
            Snackbar.Add("Status updated.", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating status: {ex.Message}", Severity.Error);
        }
    }

    // --- Time Conversion Helpers ---

    private string GetTargetTzId()
    {
        return _mode switch
        {
            TimeDisplayMode.Eastern => "Eastern Standard Time",
            TimeDisplayMode.Mountain => "Mountain Standard Time",
            _ => _employeeSiteTzId ?? "Eastern Standard Time"
        };
    }

    private DateTime ToDisplayTime(DateTime etTime)
    {
        var targetTz = GetTargetTzId();
        return Tz.FromEtToSite(etTime, targetTz);
    }

    private DateTime FromDisplayTime(DateTime displayTime)
    {
        var targetTz = GetTargetTzId();
        return Tz.FromSiteToEt(displayTime, targetTz);
    }

    // --- UI Logic ---

    private void FilterSubTypes(int typeId)
    {
        _filteredSubTypes = _rawSubTypes
            .Where(x => x.ActivityTypeId == typeId)
            .ToDictionary(k => k.Id, v => v.Name);
    }

    private void OnTypeChanged(int newTypeId)
    {
        if (_item == null) return;
        _item.ActivityTypeId = newTypeId;
        FilterSubTypes(newTypeId);

        if (!_filteredSubTypes.ContainsKey(_item.ActivitySubTypeId))
        {
            _item.ActivitySubTypeId = _filteredSubTypes.Keys.FirstOrDefault();
        }
    }

    private void StartEdit()
    {
        if (_item == null) return;

        var startDisplay = ToDisplayTime(_item.StartTime);
        var endDisplay = ToDisplayTime(_item.EndTime);

        _editStartDate = startDisplay.Date;
        _editStartTime = startDisplay.TimeOfDay;
        _editEndDate = endDisplay.Date;
        _editEndTime = endDisplay.TimeOfDay;

        FilterSubTypes(_item.ActivityTypeId);
        _isEditing = true;
    }

    private void CancelEdit()
    {
        _isEditing = false;
        _ = LoadDataAsync();
    }

    private async Task SaveAsync()
    {
        if (_item == null) return;
        if (!_editStartDate.HasValue || !_editStartTime.HasValue || !_editEndDate.HasValue || !_editEndTime.HasValue)
        {
            Snackbar.Add("Start and End times are required.", Severity.Warning);
            return;
        }

        var startDisplay = _editStartDate.Value.Date + _editStartTime.Value;
        var endDisplay = _editEndDate.Value.Date + _editEndTime.Value;

        _item.StartTime = FromDisplayTime(startDisplay);
        _item.EndTime = FromDisplayTime(endDisplay);

        // --- NEW STATUS LOGIC ---
        // Vacation (11) -> Pending (6), Else -> Submitted (1)
        int newStatus = (_item.ActivitySubTypeId == 11) ? 6 : 1;
        _item.OperaStatusId = newStatus;
        // ------------------------

        var user = await UserProfile.GetAsync();
        _item.LastUpdatedBy = user.UserName ?? "Unknown";
        try
        {
            await Repo.UpdateAsync(_item);
            Snackbar.Add("Request updated and status reset.", Severity.Success);
            _isEditing = false;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating request: {ex.Message}", Severity.Error);
        }
    }
}