@page "/admin/fix-history"
@using MyApplication.Components.Service.Admin
@inject HistoryReprocessor Reprocessor

<h3>Fix Employee History</h3>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RunFix" Disabled="_processing">
    @if (_processing)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <span> Processing...</span>
 }
    else
    {
        <span>Run Reconciliation</span>
    }
</MudButton>

@if (!string.IsNullOrEmpty(_result))
{
    <MudAlert Severity="Severity.Success" Class="mt-4">@_result</MudAlert>
}

@code {
    private bool _processing = false;
    private string _result = "";

    private async Task RunFix()
    {
        _processing = true;
        StateHasChanged();

        try
        {
            // This runs the logic we defined above
            _result = await Reprocessor.ReconcileAllAsync();
        }
        catch (Exception ex)
        {
            _result = $"Error: {ex.Message}";
        }
        finally
        {
            _processing = false;
        }
    }
}