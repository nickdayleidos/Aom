@page "/employees/schedules"
@page "/employees/schedules/{EmployeeId:int?}"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor,Tech Lead")]
@using MyApplication.Components.Service.Employee
@using MyApplication.Common.Time
@using Microsoft.AspNetCore.Components.Authorization
@inject EmployeesRepository EmployeeRepo
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthState
@implements IDisposable

<style>
    @@media print {
        .mud-layout-drawer, .mud-appbar, .d-print-none {
            display: none !important;
        }

        .mud-main-content {
            padding: 0 !important;
            margin: 0 !important;
            height: auto !important;
            overflow: visible !important;
        }

        body, .mud-typography {
            color: black !important;
            -webkit-print-color-adjust: exact;
        }

        .mud-expand-panel {
            box-shadow: none !important;
            border: 1px solid #eee;
            margin-bottom: 1rem;
        }

        tr {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
        }

        thead {
            display: table-header-group;
        }
    }

    /* Timeline styles */
    .timeline-track {
        position: relative;
        height: 100%;
        background-color: #fafafa;
        border-radius: 4px;
        overflow: hidden;
    }

    .timeline-bar {
        position: absolute;
        height: 24px;
        top: 6px;
        border-radius: 4px;
        opacity: 0.9;
        border: 1px solid rgba(0,0,0,0.1);
        cursor: help;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        white-space: nowrap;
    }

        .timeline-bar:hover {
            opacity: 1.0;
            z-index: 100 !important;
            border-color: #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

    /* --- Custom Activity Colors --- */
    .activity-offline {
        background-color: #000000 !important;
        color: #fff;
    }

    .activity-admin {
        background-color: #0D98BA !important;
        color: #fff;
    }

    .activity-system {
        background-color: #000000 !important;
        color: #fff;
    }

    .activity-available {
        background-color: #1F4E78 !important;
        color: #fff;
    }

    .activity-ol-customer {
        background-color: #FF9900 !important;
        color: #000;
    }

    .activity-peer {
        background-color: #8EBAE2 !important;
        color: #000;
    }

    .activity-break {
        background-color: #FD1FBE !important;
        color: #fff;
    }

    .activity-lunch {
        background-color: #BE0288 !important;
        color: #fff;
    }

    .activity-corporate {
        background-color: #F3AA79 !important;
        color: #000;
    }

    .activity-coaching {
        background-color: #D36113 !important;
        color: #fff;
    }

    .activity-meeting {
        background-color: #833C0C !important;
        color: #fff;
    }

    .activity-training {
        background-color: #FFFF00 !important;
        color: #000;
    }

    .activity-default {
        background-color: #9E9E9E !important;
        color: #fff;
    }

    /* Legend Chip */
    .legend-chip {
        display: inline-flex;
        align-items: center;
        margin-right: 12px;
        font-size: 0.75rem;
    }

    .legend-box {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 4px;
        border: 1px solid rgba(0,0,0,0.1);
    }
</style>

<MudStack Spacing="4" Class="mb-8">

    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="d-print-none">
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Nav.NavigateTo("/employees"))" />
            <MudText Typo="Typo.h5">Daily Schedules</MudText>
        </MudStack>

        <MudStack Row="true" Spacing="2">
            <MudButton StartIcon="@Icons.Material.Filled.PictureAsPdf"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="PrintAsync">
                Export to PDF
            </MudButton>

            <MudSelect T="SortOption"
                       @bind-Value="SortBy"
                       Label="Sort By"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Dense="true"
                       Style="min-width: 150px; background-color: var(--mud-palette-surface);">
                <MudSelectItem Value="SortOption.StartTime">Start Time</MudSelectItem>
                <MudSelectItem Value="SortOption.Name">Name</MudSelectItem>
            </MudSelect>

            <MudSelect T="TimeDisplayMode"
                       @bind-Value="Mode"
                       Label="Display Time"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Dense="true"
                       Style="min-width: 200px; background-color: var(--mud-palette-surface);">
                <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (Site)</MudSelectItem>
                <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern</MudSelectItem>
                <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudStack>

    <MudPaper Class="pa-4 d-print-none" Outlined="true">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
            <MudDatePicker Label="Select Date"
                           Date="_date"
                           DateChanged="OnDateChanged"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Editable="true" />

            <MudSpacer />

            @if (_loading)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            }
            <MudCheckBox Value="@_activeOnly" ValueChanged="@((bool v) => { _activeOnly = v; _ = LoadAsync(); })" Label="Active Only" Dense="true" Color="Color.Primary"></MudCheckBox>
            <MudCheckBox Value="@_agentsOnly" ValueChanged="@((bool v) => { _agentsOnly = v; _ = LoadAsync(); })" Label="Agents Only" Dense="true" Color="Color.Primary"></MudCheckBox>
            <MudCheckBox Value="@_hideLoa" ValueChanged="@((bool v) => { _hideLoa = v; _ = LoadAsync(); })" Label="Hide LOA" Dense="true" Color="Color.Primary"></MudCheckBox>

        </MudStack>

    </MudPaper>

    <!-- Updated Filters Row with Multi-Select -->
    <MudGrid Class="mb-4 align-center" Spacing="1">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" Label="Organization" MultiSelection="true" SelectedValues="_selectedOrgIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _selectedOrgIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="@(_ => LoadAsync())" SearchFunc="@((string x, CancellationToken ct) => SearchList(x, _options.Organizations))">
                @foreach (var org in _options.Organizations)
                {
                    <MudSelectItem Value="@org">@org</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" Label="Sub Organization" MultiSelection="true" SelectedValues="_selectedSubOrgIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _selectedSubOrgIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="@(_ => LoadAsync())" SearchFunc="@((string x, CancellationToken ct) => SearchList(x, _options.SubOrganizations))">
                @foreach (var subOrg in _options.SubOrganizations)
                {
                    <MudSelectItem Value="@subOrg">@subOrg</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" Label="Supervisor" MultiSelection="true" SelectedValues="_selectedSupervisorIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _selectedSupervisorIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="@(_ => LoadAsync())" SearchFunc="@((string x, CancellationToken ct) => SearchList(x, _options.Supervisors))">
                @foreach (var sup in _options.Supervisors)
                {
                    <MudSelectItem Value="@sup">@sup</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" Label="Manager" MultiSelection="true" SelectedValues="_selectedManagerIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _selectedManagerIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="@(_ => LoadAsync())" SearchFunc="@((string x, CancellationToken ct) => SearchList(x, _options.Managers))">
                @foreach (var man in _options.Managers)
                {
                    <MudSelectItem Value="@man">@man</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
    </MudGrid>

    @if (_vm != null)
    {
        @if (!_vm.Sites.Any())
        {
            <MudAlert Severity="Severity.Info">No schedules found for this date (and filters).</MudAlert>
        }
        else
        {
            @* --- Bind ActivePanelIndex to handle Filter Switch --- *@
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-4" @bind-ActivePanelIndex="ActiveTabIndex">

                <MudTabPanel Text="List View" Icon="@Icons.Material.Filled.List">
                    <MudExpansionPanels MultiExpansion="true">
                        @foreach (var site in _vm.Sites)
                        {
                            <MudExpansionPanel Text="@($"{site.SiteName} - {_vm.Date:ddd, MMM d, yyyy} ({site.Employees.Count} employees)")"
                                               @bind-IsExpanded="@site.IsExpanded">
                                <MudTable Items="@site.Employees" Dense="true" Hover="true" Elevation="0" Breakpoint="Breakpoint.None">
                                    <HeaderContent>
                                        <MudTh>Employee</MudTh>
                                        <MudTh>Shift Overview</MudTh>
                                        <MudTh>Detailed Schedule</MudTh>
                                        <MudTh Class="d-print-none"></MudTh>
                                    </HeaderContent>
                                    <RowTemplate Context="emp">
                                        <MudTd DataLabel="Employee" Valign="Valign.Top">
                                            <MudText Typo="Typo.body2" Style="font-weight:bold;">@emp.EmployeeName</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @emp.EmployeeId</MudText>
                                            <MudStack Spacing="0" Class="mt-2">
                                                @if (!string.IsNullOrEmpty(emp.OrganizationName))
                                                {
                                                    <MudText Typo="Typo.caption"><b>Org:</b> @emp.OrganizationName / @emp.SubOrganizationName</MudText>
                                                }
                                                @if (!string.IsNullOrEmpty(emp.SupervisorName))
                                                {
                                                    <MudText Typo="Typo.caption"><b>Sup:</b> @emp.SupervisorName</MudText>
                                                }
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Shift" Valign="Valign.Top">
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                                @emp.ShiftString
                                            </MudChip>
                                        </MudTd>
                                        <MudTd DataLabel="Activities">
                                            <MudStack Spacing="1">
                                                @foreach (var seg in emp.Segments)
                                                {
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudText Typo="Typo.body2" Style="font-family:monospace; min-width:90px;">
                                                            @seg.Start.ToString("HH:mm") - @seg.End.ToString("HH:mm")
                                                        </MudText>
                                                        @if (seg.ActivityTypeId == 6)
                                                        {
                                                            <MudText Typo="Typo.body2" Style="font-weight:bold;">@seg.SubActivityName</MudText>
                                                        }
                                                        else
                                                        {
                                                            <MudText Typo="Typo.body2" Style="font-weight:bold;">@seg.ActivityName - @seg.SubActivityName</MudText>
                                                        }
                                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Info" Class="ml-auto">
                                                            AWS: @seg.AwsStatusName
                                                        </MudChip>
                                                    </MudStack>
                                                    <MudDivider />
                                                }
                                            </MudStack>
                                        </MudTd>
                                        <MudTd Valign="Valign.Top" Class="d-print-none">
                                            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small"
                                                           OnClick="@(() => Nav.NavigateTo($"/employees/{emp.EmployeeId}"))" />
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </MudExpansionPanel>
                        }
                    </MudExpansionPanels>
                </MudTabPanel>

                @if (_canViewTimeline)
                {
                    <MudTabPanel Text="Timeline View" Icon="@Icons.Material.Filled.Timeline">

                        <MudPaper Class="pa-3 mb-3 d-flex flex-wrap align-center" Outlined="true">
                            <MudText Typo="Typo.subtitle2" Class="mr-4">Legend:</MudText>
                            @foreach (var l in _legendItems)
                            {
                                <div class="legend-chip">
                                    <div class="legend-box @l.Class"></div>
                                    <span>@l.Name</span>
                                </div>
                            }
                        </MudPaper>

                        @foreach (var site in _vm.Sites)
                        {
                            var referenceTime = _vm.Date.ToDateTime(TimeOnly.MinValue);
                            double totalMinutesToRender = 1440;

                            foreach (var e in site.Employees)
                            {
                                if (e.Segments.Any())
                                {
                                    var maxEnd = e.Segments.Max(s => s.End);
                                    var offset = (maxEnd - referenceTime).TotalMinutes;
                                    if (offset > totalMinutesToRender) totalMinutesToRender = offset;
                                }
                                if (e.AwsSegments.Any())
                                {
                                    var maxEnd = e.AwsSegments.Max(s => s.End);
                                    var offset = (maxEnd - referenceTime).TotalMinutes;
                                    if (offset > totalMinutesToRender) totalMinutesToRender = offset;
                                }
                            }

                            int totalHours = (int)Math.Ceiling(totalMinutesToRender / 60.0);
                            int minWidth = 250 + (totalHours * 50);

                            <MudPaper Class="pa-4 mb-4" Outlined="true">
                                <MudText Typo="Typo.h6" Class="mb-4">
                                    @site.SiteName - @_vm.Date.ToString("ddd, MMM d, yyyy")
                                    <span class="mud-typography-caption">(@site.TimeZoneId)</span>
                                </MudText>

                                <div style="overflow-x:auto;">
                                    @* Header Row (Hours) *@
                                    <div style="@($"display:flex; min-width: {minWidth}px; border-bottom:1px solid #ddd; margin-bottom:4px;")">
                                        <div style="width:250px; flex-shrink:0; font-weight:bold; padding-left:8px;">Employee</div>
                                        @for (int h = 0; h < totalHours; h++)
                                        {
                                            var displayH = h % 24;
                                            <div style="flex:1; text-align:left; border-left:1px solid #eee; font-size:0.75rem; padding-left:2px; color:#888;">
                                                @($"{displayH:00}:00")
                                            </div>
                                        }
                                    </div>

                                    @foreach (var emp in site.Employees)
                                    {
                                        var baseIds = new[] { 47, 49, 50, 51, 53, 54 };

                                        var baseSegments = emp.Segments
                                        .Where(s => s.ActivitySubTypeId.HasValue && baseIds.Contains(s.ActivitySubTypeId.Value))
                                        .ToList();
                                        var extraSegments = emp.Segments
                                        .Where(s => !s.ActivitySubTypeId.HasValue || !baseIds.Contains(s.ActivitySubTypeId.Value))
                                        .ToList();

                                        // Apply relative positioning and min-width to the wrapper so absolute children scale correctly
                                        <div style="@($"display:flex; flex-direction:column; border-bottom:1px solid #ddd; position:relative; min-width: {minWidth}px;")">

                                            @* ROW 1: SCHEDULE (Plan - Base) *@
                                            <div style="@($"display:flex; height: 32px; align-items:center; position:relative;")">
                                                <div style="width:250px; flex-shrink:0; padding-right:8px; padding-left:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                                    <MudText Typo="Typo.body2" Style="font-weight:bold;">@emp.EmployeeName</MudText>
                                                    <MudText Typo="Typo.caption" Style="font-size:0.7rem; color:#888;">Plan: @emp.ShiftString</MudText>
                                                </div>

                                                <div class="timeline-track" style="flex:1;">
                                                    @foreach (var seg in baseSegments)
                                                    {
                                                        var startOffset = (seg.Start - referenceTime).TotalMinutes;
                                                        var endOffset = (seg.End - referenceTime).TotalMinutes;

                                                        if (endOffset <= 0) continue;

                                                        var leftPct = (startOffset / totalMinutesToRender) * 100;
                                                        var widthPct = ((endOffset - startOffset) / totalMinutesToRender) * 100;

                                                        <div title="@($"SCHEDULE: {seg.ActivityName} - {seg.SubActivityName}\n{seg.Start:MM/dd HH:mm} - {seg.End:HH:mm}")"
                                                             class="timeline-bar @seg.ColorClass"
                                                             style="left:@($"{leftPct:F2}%"); width:@($"{widthPct:F2}%"); z-index:@seg.ZIndex;">
                                                            <span style="padding:0 4px;">
                                                                @if (!string.IsNullOrEmpty(seg.SubActivityName) && seg.SubActivityName != "-")
                                                                {
                                                                    @($"{seg.ActivityName} - {seg.SubActivityName}")
                                                                }
                                                                else
                                                                {
                                                                    @seg.ActivityName
                                                                }
                                                            </span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            @* ROW 2: SCHEDULE (Plan - Activities) - Only if exists *@
                                            @if (extraSegments.Any())
                                            {
                                                <div style="@($"display:flex; height: 32px; align-items:center; position:relative; margin-top:0;")">
                                                    <div style="width:250px; flex-shrink:0; padding-right:8px; padding-left:24px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                                        <MudText Typo="Typo.caption" Style="font-size:0.7rem; color:#888;">Activities</MudText>
                                                    </div>

                                                    <div class="timeline-track" style="flex:1;">
                                                        @foreach (var seg in extraSegments)
                                                        {
                                                            var startOffset = (seg.Start - referenceTime).TotalMinutes;
                                                            var endOffset = (seg.End - referenceTime).TotalMinutes;

                                                            if (endOffset <= 0) continue;

                                                            var leftPct = (startOffset / totalMinutesToRender) * 100;
                                                            var widthPct = ((endOffset - startOffset) / totalMinutesToRender) * 100;

                                                            <div title="@($"SCHEDULE: {seg.ActivityName} - {seg.SubActivityName}\n{seg.Start:MM/dd HH:mm} - {seg.End:HH:mm}")"
                                                                 class="timeline-bar @seg.ColorClass"
                                                                 style="left:@($"{leftPct:F2}%"); width:@($"{widthPct:F2}%"); z-index:@seg.ZIndex;">
                                                                <span style="padding:0 4px;">
                                                                    @if (!string.IsNullOrEmpty(seg.SubActivityName) && seg.SubActivityName != "-")
                                                                    {
                                                                        @($"{seg.ActivityName} - {seg.SubActivityName}")
                                                                    }
                                                                    else
                                                                    {
                                                                        @seg.ActivityName
                                                                    }
                                                                </span>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }

                                            @* ROW 3: ACTUAL (AWS) *@
                                            <div style="@($"display:flex; height: 32px; align-items:center; position:relative; background-color:#f9f9f9; border-top: 1px dotted #e0e0e0;")">
                                                <div style="width:250px; flex-shrink:0; padding-right:8px; padding-left:24px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border-right: 1px solid #f0f0f0;">
                                                    <MudText Typo="Typo.caption" Style="font-size:0.7rem; color:#666; font-style:italic;">Actual (AWS)</MudText>
                                                </div>

                                                <div class="timeline-track" style="flex:1; background-color:#f9f9f9;">
                                                    @if (emp.AwsSegments != null && emp.AwsSegments.Any())
                                                    {
                                                        foreach (var seg in emp.AwsSegments)
                                                        {
                                                            var startOffset = (seg.Start - referenceTime).TotalMinutes;
                                                            var endOffset = (seg.End - referenceTime).TotalMinutes;

                                                            if (endOffset <= 0) continue;

                                                            var leftPct = (startOffset / totalMinutesToRender) * 100;
                                                            var widthPct = ((endOffset - startOffset) / totalMinutesToRender) * 100;

                                                            <div title="@($"AWS: {seg.AwsStatusName}\n{seg.Start:MM/dd HH:mm} - {seg.End:HH:mm}")"
                                                                 class="timeline-bar @seg.ColorClass"
                                                                 style="left:@($"{leftPct:F2}%"); width:@($"{widthPct:F2}%"); z-index:20; height: 18px; top: 7px; border: 1px solid rgba(0,0,0,0.3);">
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            </div>

                                            @* OVERLAY: ALERTS (FLAGS) *@
                                            @if (emp.AlertSegments != null && emp.AlertSegments.Any())
                                            {
                                                <div style="position:absolute; top:0; bottom:0; left:250px; right:0; pointer-events:none; z-index:50;">
                                                    <div class="timeline-track" style="height:100%; background:transparent;">
                                                        @foreach (var seg in emp.AlertSegments)
                                                        {
                                                            // EXCLUSION LOGIC: Skip alert if there's a scheduled activity with SubTypeId 45 overlapping
                                                            bool isExcluded = emp.Segments.Any(plan =>
                                                            plan.ActivitySubTypeId == 45 &&
                                                            plan.Start < seg.End &&
                                                            plan.End > seg.Start);

                                                            if (isExcluded) continue;

                                                            var startOffset = (seg.Start - referenceTime).TotalMinutes;
                                                            var endOffset = (seg.End - referenceTime).TotalMinutes;

                                                            if (endOffset <= 0) continue;

                                                            var leftPct = (startOffset / totalMinutesToRender) * 100;
                                                            var widthPct = ((endOffset - startOffset) / totalMinutesToRender) * 100;

                                                            <div title="@($"ALERT: {seg.SubActivityName}\n{seg.Start:MM/dd HH:mm} - {seg.End:HH:mm}")"
                                                                 style="position:absolute; left:@($"{leftPct:F2}%"); width:@($"{widthPct:F2}%"); height: 100%; background-color: rgba(244, 67, 54, 0.4); pointer-events:auto;">
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }

                                        </div>
                                    }
                                </div>
                            </MudPaper>
                        }
                    </MudTabPanel>
                }

            </MudTabs>
        }
    }
</MudStack>

@code {
    [Parameter] public int? EmployeeId { get; set; } // --- ADDED PROPERTY TO FIX ROUTING ERROR ---

    public enum SortOption { Name, StartTime }

    private DateTime? _date = DateTime.Today;
    private ScheduleDashboardVm? _vm;
    private bool _loading = false;
    private TimeDisplayMode _mode = TimeDisplayMode.EmployeeLocal;
    private SortOption _sortBy = SortOption.StartTime;
    private CancellationTokenSource? _cts;
    private bool _canViewTimeline = false;

    // Filter Logic
    private string _query = string.Empty;
    private bool _activeOnly = true;
    private bool _agentsOnly = false;
    private bool _hideLoa = true;

    // Multi-Select Filters (Using string sets as original filter DTO used strings for names)
    private IEnumerable<string> _selectedManagerIds = new HashSet<string>();
    private IEnumerable<string> _selectedSupervisorIds = new HashSet<string>();
    private IEnumerable<string> _selectedOrgIds = new HashSet<string>();
    private IEnumerable<string> _selectedSubOrgIds = new HashSet<string>();

    private EmployeeFilterOptionsDto _options = new();

    // --- Tab Switching Logic ---
    private int _activeTabIndex = 0;
    private int ActiveTabIndex
    {
        get => _activeTabIndex;
        set
        {
            if (_activeTabIndex != value)
            {
                _activeTabIndex = value;
                if (_activeTabIndex == 1)
                {
                    _agentsOnly = true;
                }
                else
                {
                    _agentsOnly = false;
                }
                _ = LoadAsync();
            }
        }
    }

    private List<(string Name, string Class)> _legendItems = new()
    {
        ("Offline", "activity-offline"),
        ("Available", "activity-available"),
        ("OL Customer Work", "activity-ol-customer"),
        ("Admin Tasks", "activity-admin"),
        ("Break", "activity-break"),
        ("Coaching", "activity-coaching"),
        ("Lunch", "activity-lunch"),
        ("Meeting", "activity-meeting"),
        ("Peer Mentoring", "activity-peer"),
        ("System", "activity-system"),
        ("Training", "activity-training"),
        ("Corp Engagement", "activity-corporate")
    };

    private TimeDisplayMode Mode
    {
        get => _mode;
        set
        {
            _mode = value;
            _ = LoadAsync();
        }
    }

    private SortOption SortBy
    {
        get => _sortBy;
        set
        {
            _sortBy = value;
            ApplySort();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthState.GetAuthenticationStateAsync();
        var user = state.User;
        _canViewTimeline = user.IsInRole("Admin") ||
                           user.IsInRole("OST") ||
                           user.IsInRole("WFM") ||
                           user.IsInRole("Manager") ||
                           user.IsInRole("Supervisor");

        _options = await EmployeeRepo.GetFilterOptionsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
        }
    }

    private async Task OnDateChanged(DateTime? newDate)
    {
        _date = newDate;
        await LoadAsync();
    }

    private async Task OnQueryChanged(string value)
    {
        _query = value ?? string.Empty;
        await LoadAsync();
    }

    private async Task OnFilterChanged(IEnumerable<string> values, Action<IEnumerable<string>> setter)
    {
        setter(values);
        await LoadAsync();
    }

    // Helper for Autocomplete search
    private Task<IEnumerable<string>> SearchList(string value, List<string> list)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<string>>(list);
        return Task.FromResult(list.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task LoadAsync()
    {
        if (!_date.HasValue) return;

        try
        {
            _cts?.Cancel();
            _cts?.Dispose();
        }
        catch (ObjectDisposedException) { }

        _cts = new CancellationTokenSource();
        var token = _cts.Token;

        _loading = true;
        StateHasChanged();

        try
        {
            var dateOnly = DateOnly.FromDateTime(_date.Value);

            // Pass the filter values. Note that repo method expects single string for filtering.
            // We pass null here and rely on client-side filtering below for multi-select.
            _vm = await EmployeeRepo.GetDailySchedulesAsync(
                dateOnly,
                _mode,
                _query,
                _activeOnly,
                _agentsOnly,
                _hideLoa,
                null,
                null,
                null,
                null,
                token);

            // Client-side filtering logic for multi-selects
            if (_vm != null && _vm.Sites != null)
            {
                foreach (var site in _vm.Sites)
                {
                    site.Employees = site.Employees.Where(e => IsEmployeeVisible(e)).ToList();
                }
                // Remove empty sites
                _vm.Sites = _vm.Sites.Where(s => s.Employees.Any()).ToList();
            }

            // Apply sorting immediately after load
            ApplySort();
        }
        catch (OperationCanceledException) { }
        finally
        {
            if (!token.IsCancellationRequested)
            {
                _loading = false;
                StateHasChanged();
            }
        }
    }

    private bool IsEmployeeVisible(EmployeeDailyScheduleVm emp)
    {
        // Organization Filter
        if (_selectedOrgIds != null && _selectedOrgIds.Any())
        {
            if (!_selectedOrgIds.Contains(emp.OrganizationName)) return false;
        }

        // Sub Organization Filter
        if (_selectedSubOrgIds != null && _selectedSubOrgIds.Any())
        {
            if (!_selectedSubOrgIds.Contains(emp.SubOrganizationName)) return false;
        }

        // Supervisor Filter
        if (_selectedSupervisorIds != null && _selectedSupervisorIds.Any())
        {
            if (!_selectedSupervisorIds.Contains(emp.SupervisorName)) return false;
        }

        // Manager Filter - Manager name not currently available in VM, skipping for now to prevent false negatives
        /*
        if (_selectedManagerIds != null && _selectedManagerIds.Any())
        {
             // Logic would go here if ManagerName was available on VM
        }
        */

        return true;
    }

    private void ApplySort()
    {
        if (_vm == null) return;

        foreach (var site in _vm.Sites)
        {
            if (_sortBy == SortOption.StartTime)
            {
                site.Employees = site.Employees
                    .OrderBy(e =>
                    {
                        var planStart = e.Segments.Any() ? e.Segments.Min(s => s.Start) : (DateTime?)null;
                        var actualStart = e.AwsSegments.Any() ? e.AwsSegments.Min(s => s.Start) : (DateTime?)null;
                        return planStart ?? actualStart ?? DateTime.MaxValue;
                    })
                    .ThenBy(e => e.EmployeeName)
                    .ToList();
            }
            else
            {
                site.Employees = site.Employees.OrderBy(e => e.EmployeeName).ToList();
            }
        }
        StateHasChanged();
    }

    private async Task PrintAsync()
    {
        if (_vm == null) return;
        foreach (var site in _vm.Sites)
        {
            site.IsExpanded = true;
        }
        StateHasChanged();
        await Task.Delay(500);
        await JS.InvokeVoidAsync("print");
    }

    public void Dispose()
    {
        try
        {
            _cts?.Cancel();
            _cts?.Dispose();
        }
        catch (ObjectDisposedException) { }
        _cts = null;
    }
}