@page "/employees"
@using MyApplication.Components.Service.Employee
@inject EmployeesRepository Repository
@inject NavigationManager Navigation

<PageTitle>Employees</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Employees</MudText>

    <MudGrid Class="mb-4 align-center" Spacing="1">
        <MudItem xs="12" sm="6" md="2">
            <MudTextField T="string" Value="@_filter.SearchText" ValueChanged="@OnSearchTextChanged" Label="Search Name" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true" DebounceInterval="500" Clearable="true" OnClearButtonClick="LoadData" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="int" Label="Organization" MultiSelection="true" SelectedValues="@_filter.OrganizationIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _filter.OrganizationIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="OnFilterChanged" SearchFunc="@SearchOrganizations" ToStringFunc="@(id => _organizations.FirstOrDefault(x => x.Id == id)?.Name)">
                @foreach (var org in _organizations)
                {
                    <MudSelectItem Value="@org.Id">@org.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="int" Label="Sub Organization" MultiSelection="true" SelectedValues="@_filter.SubOrganizationIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _filter.SubOrganizationIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="OnFilterChanged" SearchFunc="@SearchSubOrganizations" ToStringFunc="@(id => _subOrganizations.FirstOrDefault(x => x.Id == id)?.Name)">
                @foreach (var subOrg in GetFilteredSubOrganizations())
                {
                    <MudSelectItem Value="@subOrg.Id">@subOrg.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="int" Label="Supervisor" MultiSelection="true" SelectedValues="@_filter.SupervisorIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _filter.SupervisorIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="OnFilterChanged" SearchFunc="@SearchSupervisors" ToStringFunc="@(id => _supervisors.FirstOrDefault(x => x.Id == id)?.Name)">
                @foreach (var sup in _supervisors)
                {
                    <MudSelectItem Value="@sup.Id">@sup.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="int" Label="Manager" MultiSelection="true" SelectedValues="@_filter.ManagerIds" SelectedValuesChanged="@(values => OnFilterChanged(values, x => _filter.ManagerIds = x))" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Dense="true" Clearable="true" OnClearButtonClick="OnFilterChanged" SearchFunc="@SearchManagers" ToStringFunc="@(id => _managers.FirstOrDefault(x => x.Id == id)?.Name)">
                @foreach (var man in _managers)
                {
                    <MudSelectItem Value="@man.Id">@man.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="6" sm="3" md="2" Class="d-flex align-center justify-center">
            <MudCheckBox Value="@_filter.IncludeInactive" ValueChanged="@((bool v) => OnIncludeInactiveChanged(v))" Label="Inactive" Dense="true" Color="Color.Primary"></MudCheckBox>
        </MudItem>
    </MudGrid>

    <MudDataGrid T="EmployeeDto" Items="@_employees" Filterable="false" SortMode="SortMode.Multiple" Groupable="false" Dense="true" Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.Organization" Title="Organization" />
            <PropertyColumn Property="x => x.SubOrganization" Title="Sub Organization" />
            <PropertyColumn Property="x => x.Site" Title="Site" />
            <PropertyColumn Property="x => x.Supervisor" Title="Supervisor" />
            <PropertyColumn Property="x => x.Manager" Title="Manager" />
            <TemplateColumn Title="Actions" CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Primary" Size="Size.Small" OnClick="@(() => ViewDetails(context.Item.Id))" Title="Details" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="EmployeeDto" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
    private List<EmployeeDto> _employees = new();
    private EmployeesFilterDto _filter = new();

    private List<OrganizationDto> _organizations = new();
    private List<SubOrganizationDto> _subOrganizations = new();
    private List<SiteDto> _sites = new();
    private List<SupervisorDto> _supervisors = new();
    private List<ManagerDto> _managers = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();
        await LoadData();
    }

    private async Task LoadLookups()
    {
        _organizations = await Repository.GetOrganizationsAsync();
        _subOrganizations = await Repository.GetSubOrganizationsAsync();
        _sites = await Repository.GetSitesAsync();
        _supervisors = await Repository.GetSupervisorsAsync();
        _managers = await Repository.GetManagersAsync();
    }

    private async Task LoadData()
    {
        _employees = await Repository.GetEmployeesAsync(_filter);
        StateHasChanged();
    }

    private async Task OnSearchTextChanged(string text)
    {
        _filter.SearchText = text;
        await LoadData();
    }

    // Generic handler to update the specific filter property and reload data
    private async Task OnFilterChanged(IEnumerable<int> values, Action<IEnumerable<int>> setter)
    {
        setter(values);
        await LoadData();
    }

    private async Task OnFilterChanged(MouseEventArgs args)
    {
        // This is primarily for the Clear button click which might trigger without value change immediately or needs explicit handling if bind-SelectedValues clears it first.
        // Usually SelectedValuesChanged handles the update, but OnClearButtonClick is an EventCallback<MouseEventArgs>
        // We just reload data. The binding should have updated the filter to empty.
        await LoadData();
    }

    private async Task OnIncludeInactiveChanged(bool value)
    {
        _filter.IncludeInactive = value;
        await LoadData();
    }

    private void ViewDetails(int id)
    {
        Navigation.NavigateTo($"/employees/{id}");
    }

    private IEnumerable<SubOrganizationDto> GetFilteredSubOrganizations()
    {
        if (_filter.OrganizationIds == null || !_filter.OrganizationIds.Any())
        {
            return _subOrganizations;
        }

        return _subOrganizations.Where(x => _filter.OrganizationIds.Contains(x.OrganizationId));
    }

    // Search Functions for MudSelect
    private Task<IEnumerable<int>> SearchOrganizations(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_organizations.Select(x => x.Id));
        return Task.FromResult(_organizations.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Select(x => x.Id));
    }

    private Task<IEnumerable<int>> SearchSubOrganizations(string value, CancellationToken token)
    {
        var source = GetFilteredSubOrganizations();
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(source.Select(x => x.Id));
        return Task.FromResult(source.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Select(x => x.Id));
    }

    private Task<IEnumerable<int>> SearchSupervisors(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_supervisors.Select(x => x.Id));
        return Task.FromResult(_supervisors.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Select(x => x.Id));
    }

    private Task<IEnumerable<int>> SearchManagers(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_managers.Select(x => x.Id));
        return Task.FromResult(_managers.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Select(x => x.Id));
    }
}