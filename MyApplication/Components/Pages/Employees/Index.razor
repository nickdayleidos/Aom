@page "/employees"
@using MudBlazor
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using MyApplication.Components.Service.Employee
@using MyApplication.Components.Service.Employee.Dtos
@inject EmployeesRepository Repo
@inject NavigationManager Nav
@implements IDisposable

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h5">Employees</MudText>
            <MudSpacer />
            <MudSwitch Value="_activeOnly"
                       ValueChanged="@(async (bool v) => { _activeOnly = v; await RefreshAsync(); })"
                       Color="Color.Primary"
                       Class="mr-2" />
            <MudText Class="mr-4">Active only</MudText>

            <MudTextField T="string"
                          Value="@_query"
                          ValueChanged="OnQueryChanged"
                          Placeholder="Search by Name or ID"
                          Immediate="true"
                          DebounceInterval="350"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Class="w-64" />
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-2" Outlined>
        <MudDataGrid T="EmployeeListItem" Items="_items" Hover="true" Dense="true" Bordered="true"
                     Filterable="true" SortMode="SortMode.Multiple" QuickFilter="@_quickFilter">
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="Id" Sortable="true" Filterable="true" />

                <PropertyColumn Property="x => x.LastName" Title="Last Name" Sortable="true" Filterable="true" />
                <PropertyColumn Property="x => x.FirstName" Title="First Name" Sortable="true" Filterable="true" />

                <PropertyColumn Property="x => x.Manager" Title="Manager" Sortable="true" Filterable="true" />
                <PropertyColumn Property="x => x.Supervisor" Title="Supervisor" Sortable="true" Filterable="true" />

                <PropertyColumn Property="x => x.Organization" Title="Organization" Sortable="true" Filterable="true" />
                <PropertyColumn Property="x => x.SubOrganization" Title="Sub-Org" Sortable="true" Filterable="true" />

                <TemplateColumn Title="Active" Sortable="true" Filterable="false">
                    <CellTemplate>
                        @(context.Item.IsActive ? "Yes" : "No")
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn CellClass="d-flex justify-end" Sortable="false" Filterable="false">
                    <CellTemplate>
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => GoTo(context.Item.Id))">
                            Details
                        </MudButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="EmployeeListItem" />
            </PagerContent>
            <NoRecordsContent>
                <MudText Class="pa-4">No employees found.</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
</MudStack>

@code {
    private string _query = string.Empty;
    private bool _activeOnly = true;
    private List<EmployeeListItem> _items = new();
    private CancellationTokenSource _cts = new();

    private Func<EmployeeListItem, bool> _quickFilter => x => true;

    protected override async Task OnInitializedAsync() => await RefreshAsync();

    private async Task OnQueryChanged(string value)
    {
        _query = value ?? string.Empty;
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        _cts.Cancel();
        _cts = new CancellationTokenSource();
        var ct = _cts.Token;

        // FIX: Added 'ct:' name to the argument.
        // Once 'take:' (named argument) is used, all subsequent arguments must also be named.
        _items = await Repo.SearchAsync(_query, _activeOnly, take: 1000, ct: ct);

        StateHasChanged();
    }

    private void GoTo(int id) => Nav.NavigateTo($"/employees/{id}");

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }
}