@page "/employees"
@using MudBlazor
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]
@using MyApplication.Components.Service.Employee
@using MyApplication.Components.Service.Employee.Dtos
@inject EmployeesRepository Repo
@inject NavigationManager Nav
@implements IDisposable

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-3">
            <MudText Typo="Typo.h5">Employees</MudText>
            <MudSpacer />

            <MudSwitch Value="_activeOnly"
                       ValueChanged="@(async (bool v) => { _activeOnly = v; await RefreshAsync(); })"
                       Color="Color.Primary"
                       Class="mr-2" />
            <MudText Class="mr-4">Active only</MudText>

            <MudTextField T="string"
                          Value="@_query"
                          ValueChanged="OnQueryChanged"
                          Placeholder="Search by Name or ID"
                          Immediate="true"
                          DebounceInterval="350"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Class="w-64" />
        </MudStack>

        <MudDivider Class="my-2" />

        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudAutocomplete T="string" Label="Manager"
                                 Value="_selectedManager"
                                 ValueChanged="@(async (string s) => { _selectedManager = s; await RefreshAsync(); })"
                                 SearchFunc="@((x, ct) => SearchList(x, _options.Managers))"
                                 Clearable="true" Dense="true" Variant="Variant.Outlined" Margin="Margin.Dense"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudAutocomplete T="string" Label="Supervisor"
                                 Value="_selectedSupervisor"
                                 ValueChanged="@(async (string s) => { _selectedSupervisor = s; await RefreshAsync(); })"
                                 SearchFunc="@((x, ct) => SearchList(x, _options.Supervisors))"
                                 Clearable="true" Dense="true" Variant="Variant.Outlined" Margin="Margin.Dense"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudAutocomplete T="string" Label="Organization"
                                 Value="_selectedOrg"
                                 ValueChanged="@(async (string s) => { _selectedOrg = s; await RefreshAsync(); })"
                                 SearchFunc="@((x, ct) => SearchList(x, _options.Organizations))"
                                 Clearable="true" Dense="true" Variant="Variant.Outlined" Margin="Margin.Dense"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudAutocomplete T="string" Label="Sub-Organization"
                                 Value="_selectedSubOrg"
                                 ValueChanged="@(async (string s) => { _selectedSubOrg = s; await RefreshAsync(); })"
                                 SearchFunc="@((x, ct) => SearchList(x, _options.SubOrganizations))"
                                 Clearable="true" Dense="true" Variant="Variant.Outlined" Margin="Margin.Dense"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true" />
            </MudItem>
        </MudGrid>

    </MudPaper>

    <MudPaper Class="pa-2" Outlined>
        <MudDataGrid T="EmployeeListItem" Items="_items" Hover="true" Dense="true" Bordered="true"
                     Filterable="false" SortMode="SortMode.Multiple">
            <Columns>
                <PropertyColumn Property="x => x.DisplayName" Title="Employee" Sortable="true" />

                <PropertyColumn Property="x => x.Manager" Title="Manager" Sortable="true" />
                <PropertyColumn Property="x => x.Supervisor" Title="Supervisor" Sortable="true" />
                <PropertyColumn Property="x => x.Organization" Title="Organization" Sortable="true" />
                <PropertyColumn Property="x => x.SubOrganization" Title="Sub-Org" Sortable="true" />

                <TemplateColumn CellClass="d-flex justify-end" Sortable="false">
                    <CellTemplate>
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => GoTo(context.Item.Id))">
                            Details
                        </MudButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="EmployeeListItem" />
            </PagerContent>
            <NoRecordsContent>
                <MudText Class="pa-4">No employees found.</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
</MudStack>

@code {
    private string _query = string.Empty;
    private bool _activeOnly = true;

    // Filter Selections
    private string? _selectedManager;
    private string? _selectedSupervisor;
    private string? _selectedOrg;
    private string? _selectedSubOrg;

    private List<EmployeeListItem> _items = new();
    private EmployeeFilterOptionsDto _options = new(); 

    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        _options = await Repo.GetFilterOptionsAsync();
        await RefreshAsync();
    }

    private async Task OnQueryChanged(string value)
    {
        _query = value ?? string.Empty;
        await RefreshAsync();
    }

    // Helper for Autocomplete search
    private Task<IEnumerable<string>> SearchList(string value, List<string> list)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<string>>(list);
        
        return Task.FromResult(list.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task RefreshAsync()
    {
        try
        {
            _cts?.Cancel();
            _cts?.Dispose();
        }
        catch (ObjectDisposedException) { }

        _cts = new CancellationTokenSource();
        var ct = _cts.Token;

        try
        {
            _items = await Repo.SearchAsync(
                query: _query,
                activeOnly: _activeOnly,
                manager: _selectedManager,
                supervisor: _selectedSupervisor,
                org: _selectedOrg,
                subOrg: _selectedSubOrg,
                take: 1000,
                ct: ct);

            StateHasChanged();
        }
        catch (TaskCanceledException)
        {
            // Ignore
        }
    }

    private void GoTo(int id) => Nav.NavigateTo($"/employees/{id}");

    public void Dispose()
    {
        try
        {
            _cts?.Cancel();
            _cts?.Dispose();
        }
        catch (ObjectDisposedException) { }

        _cts = null;
    }
}