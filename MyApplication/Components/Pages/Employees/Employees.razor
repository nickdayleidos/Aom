@page "/employee"
@using Microsoft.AspNetCore.Authorization
@using MyApplication.Components.Model
@using MyApplication.Components.Model.AOM
@using MyApplication.Components.Model.AOM.Employee
@using MyApplication.Components.Service
@attribute [Authorize(Policy = "Admin")]
@using MudBlazor

@inject IEmployeeService EmployeeService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDataGrid T="EmployeeDetailsDto"
             Items="@_employees"
             Loading="@_loading"
             Hover="true"
             Dense="false"
             Striped="false"
             Bordered="false"
             ReadOnly="true"
             Class="elevation-1">

    <ToolBarContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="w-100">
            <MudText Typo="Typo.h6" Class="mud-primary-text">
                Team Members (@_employees.Count)
            </MudText>

            <MudSpacer />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenCreateDialog">
                New Employee
            </MudButton>
        </MudStack>
    </ToolBarContent>

    <Columns>

        <!-- Last Name -->
        <TemplateColumn Title="Last Name"
                        SortBy="e => e.LastName"
                        Filter="e => e.LastName">
            <CellTemplate Context="context">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudAvatar Color="Color.Secondary" Size="Size.Medium">
                        @(context.Item.LastName?.FirstOrDefault())
                    </MudAvatar>
                    <MudText class="ml-2">@context.Item.LastName</MudText>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>

        <!-- First Name -->
        <TemplateColumn Title="First Name"
                        SortBy="e => e.FirstName"
                        Filter="e => e.FirstName">
            <CellTemplate Context="context">
                <MudChip Size="Size.Small">
                    @context.Item.FirstName
                </MudChip>
            </CellTemplate>
        </TemplateColumn>

        <!-- Middle Initial -->
        <TemplateColumn Title="Middle Initial"
                        SortBy="e => e.MiddleInitial"
                        Filter="e => e.MiddleInitial">
            <CellTemplate Context="context">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Small" />
                    <MudText class="ml-1">@context.Item.MiddleInitial</MudText>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>

        <!-- Actions -->
        <TemplateColumn Title="Actions" TextAlignment="TextAlignment.Right">
            <CellTemplate Context="context">
                <MudStack Row="true" Spacing="0" Class="pa-2">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                   Size="Size.Small" Class="mx-1"
                                   OnClick="@(() => OpenEditDialog(context.Item))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                   Size="Size.Small" Class="mx-1"
                                   OnClick="@(() => OpenDeleteDialog(context.Item.Id))" />
                </MudStack>
            </CellTemplate>
        </TemplateColumn>

    </Columns>

    <PagerContent>
        <MudDataGridPager T="EmployeeDetailsDto" PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
    </PagerContent>
</MudDataGrid>



@code {
    private List<EmployeeDetailsDto> _employees = new();
    private bool _loading = true;
    private string _searchString = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();

    }

    private async Task LoadEmployees()
    {
        try
        {
            _loading = true;
            StateHasChanged();

            _employees = (await EmployeeService.GetAllEmployeesAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load employees", Severity.Error);
            // Consider logging the exception here
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }


    @*  Delete Dialog *@

    private async Task OpenEditDialog(EmployeeDetailsDto employee)
    {
        var parameters = new DialogParameters
            {
                ["Employee"] = employee,
                ["Title"] = $"Edit Employee: {employee.LastName}"
            };

        var dialog = await DialogService.ShowAsync<EditEmployee>("Edit Employee", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadEmployees();
            Snackbar.Add("Employee updated successfully", Severity.Success);
        }
    }



    @* Delete Dialog  *@
    private async Task OpenDeleteDialog(int employeeId)
    {
        var parameters = new DialogParameters
            {
                ["EmployeeId"] = employeeId,
                ["Message"] = "Are you sure you want to delete this employee? This action cannot be undone."
            };

        var dialog = await DialogService.ShowAsync<DeleteConfirmation>("Confirm Deletion", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await EmployeeService.DeleteEmployeeAsync(employeeId);
                await LoadEmployees();
                Snackbar.Add("Employee deleted successfully", Severity.Success);
            }
            catch (Exception)
            {
                Snackbar.Add("Failed to delete employee", Severity.Error);
            }
        }
    }



    @*  Create Dialog *@

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateEmployee>("Add New Employee");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadEmployees();
            Snackbar.Add("Employee created successfully", Severity.Success);
        }
    }
}