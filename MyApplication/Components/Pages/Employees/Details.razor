@page "/employees/{Id:int}"
@* 1. PAGE ACCESS: Expanded to include OST, WFM, Managers, Supervisors *@
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]

@using MyApplication.Components.Service.Employee
@using MyApplication.Components.Service.Employee.Dtos
@using MyApplication.Components.Pages.Employees.Dialogs
@using MyApplication.Common.Time
@inject EmployeesRepository Repository
@inject NavigationManager Nav
@inject IDialogService DialogService

<MudStack Spacing="4" Class="mb-8">
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Nav.NavigateTo("/employees"))" />
        <MudText Typo="Typo.h5">Employee Details</MudText>
        <MudSpacer />
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.caption">Time:</MudText>
            <MudSelect T="TimeDisplayMode" Dense="true" Margin="Margin.Dense" @bind-Value="_mode" Variant="Variant.Outlined" Style="min-width:160px">
                <MudSelectItem Value="TimeDisplayMode.EmployeeLocal">Local (Site)</MudSelectItem>
                <MudSelectItem Value="TimeDisplayMode.Eastern">Eastern</MudSelectItem>
                <MudSelectItem Value="TimeDisplayMode.Mountain">Mountain</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudStack>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_vm == null)
    {
        <MudAlert Severity="Severity.Error">Employee not found.</MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4 h-100" Outlined="true">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Profile</MudText>

                        @* 2. EDIT PROFILE: Allowed for WFM, Manager, Supervisor, Admin *@
                        <AuthorizeView Roles="Admin,WFM,Manager,Supervisor">
                            <Authorized>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="EditProfileAsync" />
                            </Authorized>
                        </AuthorizeView>

                    </MudStack>

                    <MudSimpleTable Dense="true" Hover="false" Striped="false" Elevation="0">
                        <tbody>
                            <tr><td><b>Name</b></td><td>@_vm.LastName, @_vm.FirstName @_vm.MiddleInitial</td></tr>
                            <tr><td><b>Corp ID</b></td><td>@_vm.CorporateId</td></tr>
                            <tr><td><b>Domain</b></td><td>@_vm.DomainLoginName</td></tr>
                            <tr><td><b>Email</b></td><td>@_vm.CorporateEmail</td></tr>
                            <tr><td><b>NMCI</b></td><td>@_vm.NmciEmail</td></tr>
                            <tr><td><b>USN IDs</b></td><td>@_vm.UsnOperatorId / @_vm.UsnAdminId</td></tr>
                            <tr>
                                <td><b>AWS User</b></td>
                                <td>
                                    @if (!string.IsNullOrEmpty(_vm.AwsUsername))
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">@_vm.AwsUsername</MudChip>
                                    }
                                    else
                                    {
                                        <span class="mud-text-secondary">-</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4 h-100" Outlined="true">
                    <MudText Typo="Typo.h6" Class="mb-4" Color="Color.Primary">Current Assignment</MudText>
                    @if (_vm.HasHistory)
                    {
                        <MudSimpleTable Dense="true" Hover="false" Striped="false" Elevation="0">
                            <tbody>
                                <tr><td><b>Effective</b></td><td>@_vm.EffectiveDate</td></tr>
                                <tr><td><b>Employer</b></td><td>@_vm.Employer</td></tr>
                                <tr><td><b>Site</b></td><td>@_vm.Site</td></tr>
                                <tr><td><b>Org</b></td><td>@_vm.Organization / @_vm.SubOrganization</td></tr>
                                <tr><td><b>Manager</b></td><td>@_vm.Manager</td></tr>
                                <tr><td><b>Supervisor</b></td><td>@_vm.Supervisor</td></tr>
                                <tr>
                                    <td><b>Status</b></td>
                                    <td>
                                        <MudChip T="bool" Size="Size.Small" Color="@(_vm.IsRemote? Color.Success: Color.Default)">Remote: @_vm.IsRemote</MudChip>
                                        @if (_vm.IsLoa)
                                        {
                                            <MudChip T="bool" Size="Size.Small" Color="Color.Warning">LOA</MudChip>
                                        }
                                        @if (_vm.IsIntLoa)
                                        {
                                            <MudChip T="bool" Size="Size.Small" Color="Color.Warning">Int LOA</MudChip>
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </MudSimpleTable>
                    }
                    else
                    {
                        <MudText Color="Color.Secondary">No assignment history found.</MudText>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudPaper Class="pa-4" Outlined="true">
            <MudText Typo="Typo.h6" Class="mb-2" Color="Color.Success">Active Skills</MudText>
            @if (_vm.Skills.Any())
            {
                <MudChipSet T="string" ReadOnly="true">
                    @foreach (var skill in _vm.Skills)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">@skill</MudChip>
                    }
                </MudChipSet>
            }
            else
            {
                <MudText Typo="Typo.caption">No active skills recorded.</MudText>
            }
        </MudPaper>

        <EmployeeRoutingAssignment EmployeeId="@Id" />

        @if (_vm.Schedule != null)
        {
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-2" Color="Color.Primary">Current Schedule</MudText>

                <MudText Typo="Typo.subtitle2" Class="ml-2">Shift 1</MudText>
                <MudSimpleTable Style="overflow-x: auto;" Dense="true" Class="mb-3">
                    <thead><tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>@DisplayTime(_vm.Schedule.MonStart, _vm.Schedule.MonEnd)</td>
                            <td>@DisplayTime(_vm.Schedule.TueStart, _vm.Schedule.TueEnd)</td>
                            <td>@DisplayTime(_vm.Schedule.WedStart, _vm.Schedule.WedEnd)</td>
                            <td>@DisplayTime(_vm.Schedule.ThuStart, _vm.Schedule.ThuEnd)</td>
                            <td>@DisplayTime(_vm.Schedule.FriStart, _vm.Schedule.FriEnd)</td>
                            <td>@DisplayTime(_vm.Schedule.SatStart, _vm.Schedule.SatEnd)</td>
                            <td>@DisplayTime(_vm.Schedule.SunStart, _vm.Schedule.SunEnd)</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                @if (_vm.Schedule2 != null)
                {
                    <MudText Typo="Typo.subtitle2" Class="ml-2 mt-4">Shift 2 (Split)</MudText>
                    <MudSimpleTable Style="overflow-x: auto;" Dense="true">
                        <thead><tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr></thead>
                        <tbody>
                            <tr>
                                <td>@DisplayTime(_vm.Schedule2.MonStart, _vm.Schedule2.MonEnd)</td>
                                <td>@DisplayTime(_vm.Schedule2.TueStart, _vm.Schedule2.TueEnd)</td>
                                <td>@DisplayTime(_vm.Schedule2.WedStart, _vm.Schedule2.WedEnd)</td>
                                <td>@DisplayTime(_vm.Schedule2.ThuStart, _vm.Schedule2.ThuEnd)</td>
                                <td>@DisplayTime(_vm.Schedule2.FriStart, _vm.Schedule2.FriEnd)</td>
                                <td>@DisplayTime(_vm.Schedule2.SatStart, _vm.Schedule2.SatEnd)</td>
                                <td>@DisplayTime(_vm.Schedule2.SunStart, _vm.Schedule2.SunEnd)</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                }
            </MudPaper>
        }

        @if (_vm.Overtime != null)
        {
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-2" Color="Color.Warning">Overtime Adjustment</MudText>
                <MudSimpleTable Dense="true">
                    <thead><tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>@_vm.Overtime.Mon</td>
                            <td>@_vm.Overtime.Tue</td>
                            <td>@_vm.Overtime.Wed</td>
                            <td>@_vm.Overtime.Thu</td>
                            <td>@_vm.Overtime.Fri</td>
                            <td>@_vm.Overtime.Sat</td>
                            <td>@_vm.Overtime.Sun</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        }

        @if (_vm.StaticBreaks != null)
        {
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-2" Color="Color.Info">Static Break Schedule</MudText>
                <MudSimpleTable Dense="true">
                    <thead><tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>@_vm.StaticBreaks.Mon</td>
                            <td>@_vm.StaticBreaks.Tue</td>
                            <td>@_vm.StaticBreaks.Wed</td>
                            <td>@_vm.StaticBreaks.Thu</td>
                            <td>@_vm.StaticBreaks.Fri</td>
                            <td>@_vm.StaticBreaks.Sat</td>
                            <td>@_vm.StaticBreaks.Sun</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        }

        <MudPaper Class="pa-4" Outlined="true">
            <MudText Typo="Typo.h6" Class="mb-2">History</MudText>
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-2">

                <MudTabPanel Text="ACR History">
                    <MudTable Items="_vm.AcrHistory" Dense="true" Hover="true" Striped="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>ID</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Effective</MudTh>
                            <MudTh>Submitted</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Id</MudTd>
                            <MudTd>@context.Type</MudTd>
                            <MudTd>@context.Status</MudTd>
                            <MudTd>@context.EffectiveDate</MudTd>
                            <MudTd>@context.Submitted</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => Nav.NavigateTo($"/acr/{context.Id}"))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudTabPanel>

                <MudTabPanel Text="OPERA History">
                    <MudTable Items="_vm.OperaHistory" Dense="true" Hover="true" Striped="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>ID</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Sub-Type</MudTh>
                            <MudTh>Start</MudTh>
                            <MudTh>End</MudTh>
                            <MudTh>Status</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.RequestId</MudTd>
                            <MudTd>@context.Type</MudTd>
                            <MudTd>@context.SubType</MudTd>
                            <MudTd>@DisplayDateTime(context.StartTime)</MudTd>
                            <MudTd>@DisplayDateTime(context.EndTime)</MudTd>
                            <MudTd>@context.Status</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudTabPanel>

            </MudTabs>
        </MudPaper>
    }
</MudStack>

@code {
    [Parameter] public int Id { get; set; }
    private EmployeeFullDetailsVm _vm;
    private bool _loading = true;

    // Default to Local time (Site)
    private TimeDisplayMode _mode = TimeDisplayMode.EmployeeLocal;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        _vm = await Repository.GetFullDetailsAsync(Id);
        _loading = false;
        StateHasChanged();
    }

    private async Task EditProfileAsync()
    {
        if (_vm == null) return;

        // Map VM to DTO
        var dto = new EmployeeProfileUpdateDto
        {
            Id = _vm.EmployeeId,
            FirstName = _vm.FirstName,
            LastName = _vm.LastName,
            MiddleInitial = _vm.MiddleInitial,
            NmciEmail = _vm.NmciEmail,
            UsnOperatorId = _vm.UsnOperatorId,
            UsnAdminId = _vm.UsnAdminId,
            CorporateEmail = _vm.CorporateEmail,
            CorporateId = _vm.CorporateId,
            DomainLoginName = _vm.DomainLoginName,
            AwsId = _vm.AwsId
        };

        var parameters = new DialogParameters { ["Model"] = dto };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<EditProfileDialog>("Edit Profile", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updatedDto = (EmployeeProfileUpdateDto)result.Data;
            await Repository.UpdateProfileAsync(updatedDto);
            // Refresh
            await LoadDataAsync();
        }
    }

    private string DisplayTime(TimeOnly? start, TimeOnly? end)
    {
        if (start is null || end is null) return "OFF";
        var s = Convert(start);
        var e = Convert(end);
        if (s is null || e is null) return "OFF";
        return $"{s:HH:mm}-{e:HH:mm}";
    }

    private string DisplayDateTime(DateTime et)
    {
        var targetTz = GetTargetTimeZone();
        var easternTz = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

        // Treat DB time as ET (Unspecified)
        var dtOffset = new DateTimeOffset(et, easternTz.GetUtcOffset(et));
        var dtLocal = TimeZoneInfo.ConvertTime(dtOffset, targetTz);

        return dtLocal.ToString("MM/dd/yy HH:mm");
    }

    private TimeOnly? Convert(TimeOnly? et)
    {
        if (et is null) return null;
        if (_mode == TimeDisplayMode.Eastern) return et;

        var targetTz = GetTargetTimeZone();
        var easternTz = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

        // Use a dummy date to perform the conversion
        var dtEt = new DateTime(2000, 1, 1, et.Value.Hour, et.Value.Minute, 0, DateTimeKind.Unspecified);

        // Treat input as ET, convert to UTC, then to Target
        var dtOffset = new DateTimeOffset(dtEt, easternTz.GetUtcOffset(dtEt));
        var dtLocal = TimeZoneInfo.ConvertTime(dtOffset, targetTz);

        return new TimeOnly(dtLocal.Hour, dtLocal.Minute);
    }

    private TimeZoneInfo GetTargetTimeZone()
    {
        if (_mode == TimeDisplayMode.Eastern)
            return TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

        var targetTzId = _mode switch
        {
            TimeDisplayMode.EmployeeLocal => string.IsNullOrWhiteSpace(_vm?.SiteTimeZoneId)
                ? "Eastern Standard Time"
                : _vm.SiteTimeZoneId,
            TimeDisplayMode.Mountain => "Mountain Standard Time",
            _ => "Eastern Standard Time"
        };

        try
        {
            return TimeZoneInfo.FindSystemTimeZoneById(targetTzId);
        }
        catch
        {
            // Fallback to ET if lookup fails
            return TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
        }
    }
}