@page "/wfm/aws/profiles/{id:int}"
@attribute [Authorize(Roles = "Admin,WFM")]
@using MyApplication.Components.Model.AOM.Aws
@using MyApplication.Components.Service.Aws
@inject AwsRoutingService Service
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudStack Spacing="4">
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Nav.NavigateTo("/wfm/aws/profiles"))" />
        <MudText Typo="Typo.h5">@_profile?.Name</MudText>
    </MudStack>

    @if (_profile != null)
    {
        <MudPaper Class="pa-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText Typo="Typo.h6">Assigned Queues</MudText>
                <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" OnClick="AddQueue">Add Queue</MudButton>
            </MudStack>

            <MudTable Items="_queues" Dense="true" Hover="true" Class="mt-4">
                <HeaderContent>
                    <MudTh>Queue</MudTh>
                    <MudTh>Priority</MudTh>
                    <MudTh>Delay</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.CallQueue?.Name</MudTd>
                    <MudTd>@context.Priority</MudTd>
                    <MudTd>@context.Delay</MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => EditQueue(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveQueue(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
    else
    {
        <MudProgressCircular Indeterminate="true" />
    }
</MudStack>

@code {
    [Parameter] public int Id { get; set; }

    private RoutingProfile? _profile;
    private List<RoutingProfileQueue> _queues = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _profile = await Service.GetProfileDetailsAsync(Id);
        _queues = await Service.GetQueuesForProfileAsync(Id);
    }

    private async Task AddQueue()
    {
        var parameters = new DialogParameters { ["ProfileId"] = Id };
        var dialog = await DialogService.ShowAsync<AddQueueToProfileDialog>("Add Queue to Profile", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("Queue added", Severity.Success);
        }
    }

    private async Task EditQueue(RoutingProfileQueue mapping)
    {
        var parameters = new DialogParameters
        {
            ["ProfileId"] = Id,
            ["ExistingMapping"] = mapping
        };
        var dialog = await DialogService.ShowAsync<AddQueueToProfileDialog>("Edit Queue Assignment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("Queue assignment updated", Severity.Success);
        }
    }

    private async Task RemoveQueue(RoutingProfileQueue item)
    {
        var confirm = await DialogService.ShowMessageBox("Remove Queue", "Are you sure?", yesText: "Remove", cancelText: "Cancel");
        if (confirm == true)
        {
            await Service.RemoveQueueFromProfileAsync(item.Id);
            await LoadData();
            Snackbar.Add("Queue removed", Severity.Success);
        }
    }
}