@page "/training/skills"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]

@using MudBlazor
@using MyApplication.Components.Model.AOM.Employee
@using MyApplication.Components.Service.Training

@inject ISkillsService SkillsService
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined="true">

        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">Skills Lookup</MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="@(() => Nav.NavigateTo("/training/skills/new"))">
                Add Skill
            </MudButton>
        </MudStack>

        <MudDivider Class="my-3" />

        <MudGrid Spacing="2" AlignItems="Center">
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_employeeSearch"
                              Placeholder="Search employee (Name)..."
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              OnKeyDown="@(e => { if (e.Key == "Enter") RefreshAsync(); })"
                              Clearable="true" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="SkillType"
                                 Label="Skill Type"
                                 Dense="true"
                                 Clearable="true"
                                 Value="_selectedSkillTypeObj"
                                 ValueChanged="OnSkillTypeChanged"
                                 SearchFunc="SearchSkillTypes"
                                 ToStringFunc="@(s => s?.Name)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string> ?"
                                 Label="Manager"
                                 Dense="true"
                                 Clearable="true"
                                 Value="_selectedManagerKv"
                                 ValueChanged="OnManagerKvChanged"
                                 SearchFunc="SearchManagers"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudAutocomplete T="KeyValuePair<int, string> ?"
                                 Label="Supervisor"
                                 Dense="true"
                                 Clearable="true"
                                 Value="_selectedSupervisorKv"
                                 ValueChanged="OnSupervisorKvChanged"
                                 SearchFunc="SearchSupervisors"
                                 ToStringFunc="@(kv => kv?.Value)"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 AdornmentIcon="@Icons.Material.Outlined.Search" />
            </MudItem>

            <MudItem xs="12" md="3" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           OnClick="ClearFilters"
                           StartIcon="@Icons.Material.Outlined.FilterAltOff">
                    Reset
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="RefreshAsync"
                           StartIcon="@Icons.Material.Outlined.Search">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudTabs @bind-ActivePanelIndex="_tabIndex" Rounded="true" Elevation="0" Color="Color.Transparent" Class="mt-4">

            <MudTabPanel Text="Line Items" Icon="@Icons.Material.Outlined.ViewList">
                <MudTable T="SkillLookupRow"
                          @ref="_tableLineItems"
                          ServerData="ServerReloadLineItems"
                          Dense="true"
                          Hover="true"
                          Bordered="false"
                          Striped="true"
                          Elevation="0"
                          RowsPerPage="50">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel SortLabel="EmployeeName" T="SkillLookupRow">Employee</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortLabel="SkillTypeName" T="SkillLookupRow">Skill</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortLabel="SkillDate" T="SkillLookupRow">Date</MudTableSortLabel></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.EmployeeName</MudTd>
                        <MudTd>@context.SkillTypeName</MudTd>
                        <MudTd>@context.SkillDate.ToString("MM/dd/yyyy")</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Class="pa-4 text-center">No skills found with the selected filters.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="By Employee" Icon="@Icons.Material.Outlined.Groups">
                <MudTable T="SkillEmployeeSummaryRow"
                          @ref="_tableSummary"
                          ServerData="ServerReloadSummary"
                          Dense="true"
                          Hover="true"
                          Bordered="false"
                          Striped="true"
                          Elevation="0"
                          RowsPerPage="50">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel SortLabel="EmployeeName" T="SkillEmployeeSummaryRow">Employee</MudTableSortLabel></MudTh>
                        <MudTh>Skills</MudTh>
                        <MudTh><MudTableSortLabel SortLabel="EffectiveDate" T="SkillEmployeeSummaryRow">Effective Date</MudTableSortLabel></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.EmployeeName</MudTd>
                        <MudTd>
                            @{
                                var orderedSkills = context.Skills.OrderBy(s => s.SkillName).ToList();
                            }
                            <MudChipSet T="string" ReadOnly="true">
                                @for (int i = 0; i < orderedSkills.Count; i++)
                                {
                                    var s = orderedSkills[i];
                                    <MudChip Color="@GetSkillColorByIndex(i)" Size="Size.Small" Variant="Variant.Filled" Class="mr-1 mb-1">
                                        @s.SkillName
                                    </MudChip>
                                }
                            </MudChipSet>
                        </MudTd>
                        <MudTd>@context.EffectiveDate.ToString("MM/dd/yyyy")</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Class="pa-4 text-center">No employee skills found with the selected filters.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
            </MudTabPanel>

        </MudTabs>
    </MudPaper>
</MudStack>

@code {
    private string? _employeeSearch;
    private int _tabIndex;

    // References to tables to trigger reload
    private MudTable<SkillLookupRow>? _tableLineItems;
    private MudTable<SkillEmployeeSummaryRow>? _tableSummary;

    // Data Sources for Dropdowns
    private IReadOnlyList<SkillType> _skillTypes = Array.Empty<SkillType>();
    private List<KeyValuePair<int, string>> _managers = new();
    private List<KeyValuePair<int, string>> _supervisors = new();

    // Bound Objects
    private SkillType? _selectedSkillTypeObj;
    private KeyValuePair<int, string>? _selectedManagerKv;
    private KeyValuePair<int, string>? _selectedSupervisorKv;

    // Derived IDs
    private int? _selectedSkillTypeId => _selectedSkillTypeObj?.Id;
    private int? _managerId => _selectedManagerKv?.Key;
    private int? _supervisorId => _selectedSupervisorKv?.Key;

    private static readonly Color[] SkillColorPalette = new[]
    {
        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark,Color.Default
    };

    private Color GetSkillColorByIndex(int index) => index < 0 ? Color.Default : SkillColorPalette[index % SkillColorPalette.Length];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var tTypes = SkillsService.GetSkillTypesAsync(true);
            var tManagers = SkillsService.GetManagersAsync();
            var tSupervisors = SkillsService.GetSupervisorsAsync();

            await Task.WhenAll(tTypes, tManagers, tSupervisors);

            _skillTypes = await tTypes;
            _managers = await tManagers;
            _supervisors = await tSupervisors;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading lookups: {ex.Message}", Severity.Error);
        }
        // No need to call RefreshAsync here, MudTable calls ServerData automatically on first render
    }

    // --- Server Side Data Providers ---

    private async Task<TableData<SkillLookupRow>> ServerReloadLineItems(TableState state, CancellationToken ct)
    {
        var search = new SkillSearchVm(
             EmployeeSearch: _employeeSearch,
             SkillTypeId: _selectedSkillTypeId,
             ManagerId: _managerId,
             SupervisorId: _supervisorId
         );

        try
        {
            var result = await SkillsService.SearchSkillsServerDataAsync(
                search,
                state.Page,
                state.PageSize,
                state.SortLabel,
                (int)state.SortDirection,
                ct);

            return new TableData<SkillLookupRow> { TotalItems = result.TotalCount, Items = result.Items };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
            return new TableData<SkillLookupRow> { TotalItems = 0, Items = Array.Empty<SkillLookupRow>() };
        }
    }

    private async Task<TableData<SkillEmployeeSummaryRow>> ServerReloadSummary(TableState state, CancellationToken ct)
    {
        var search = new SkillSearchVm(
             EmployeeSearch: _employeeSearch,
             SkillTypeId: _selectedSkillTypeId,
             ManagerId: _managerId,
             SupervisorId: _supervisorId
         );

        try
        {
            var result = await SkillsService.GetEmployeeSkillSummariesServerDataAsync(
                search,
                state.Page,
                state.PageSize,
                state.SortLabel,
                (int)state.SortDirection,
                ct);

            return new TableData<SkillEmployeeSummaryRow> { TotalItems = result.TotalCount, Items = result.Items };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
            return new TableData<SkillEmployeeSummaryRow> { TotalItems = 0, Items = Array.Empty<SkillEmployeeSummaryRow>() };
        }
    }

    // --- Search Helpers (Dropdowns) ---

    private Task<IEnumerable<SkillType>> SearchSkillTypes(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value)) return Task.FromResult<IEnumerable<SkillType>>(_skillTypes);
        return Task.FromResult(_skillTypes.Where(x => x.Name.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchManagers(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_managers.Select(x => (KeyValuePair<int, string>?)x));
        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _managers.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                     .Select(x => (KeyValuePair<int, string>?)x));
    }

    private Task<IEnumerable<KeyValuePair<int, string>?>> SearchSupervisors(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(_supervisors.Select(x => (KeyValuePair<int, string>?)x));
        return Task.FromResult<IEnumerable<KeyValuePair<int, string>?>>(
            _supervisors.Where(x => x.Value.Contains(value, StringComparison.OrdinalIgnoreCase))
                        .Select(x => (KeyValuePair<int, string>?)x));
    }

    // --- Handlers ---

    private void OnSkillTypeChanged(SkillType? val) { _selectedSkillTypeObj = val; }
    private void OnManagerKvChanged(KeyValuePair<int, string>? val) { _selectedManagerKv = val; }
    private void OnSupervisorKvChanged(KeyValuePair<int, string>? val) { _selectedSupervisorKv = val; }

    private void ClearFilters()
    {
        _employeeSearch = null;
        _selectedSkillTypeObj = null;
        _selectedManagerKv = null;
        _selectedSupervisorKv = null;
        RefreshAsync();
    }

    private void RefreshAsync()
    {
        _tableLineItems?.ReloadServerData();
        _tableSummary?.ReloadServerData();
    }
}