@page "/training/skills"
@attribute [Authorize(Policy = "Admin")]

@using MudBlazor
@using MyApplication.Components.Model.AOM.Employee
@using MyApplication.Components.Service.Training

@inject ISkillService SkillService
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined="true">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">Skills Lookup</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="@(() => Nav.NavigateTo("/training/skills/new"))">
                Add Skill
            </MudButton>
        </MudStack>

        <!-- Filters ----------------------------------------------------->
        <MudStack Class="mt-3" Spacing="2">
            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                <MudTextField @bind-Value="_employeeSearch"
                              Label="Employee (name)"
                              Dense
                              Immediate="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              Class="mr-2"
                              OnBlur="@(_ => RefreshAsync())" />

                <!-- Skill type filter (nullable int) -->
                <MudSelect T="int?" Label="Skill Type"
                           Dense
                           @bind-Value="_selectedSkillTypeId"
                           Class="mr-2"
                           Clearable="true"
                           ResetValueOnEmptyText="true"
                           Style="min-width: 220px;">
                    @foreach (var st in _skillTypes)
                    {
                        <MudSelectItem Value="@((int?)st.Id)">@st.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSpacer />

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="RefreshAsync">
                    Search
                </MudButton>
            </MudStack>

            <!-- Tabs ----------------------------------------------------->
            <MudTabs @bind-ActivePanelIndex="_tabIndex"
                     Rounded="true"
                     Elevation="0"
                     Class="mt-2">

                <!-- Tab 1: Line-item view -->
                <MudTabPanel Text="Line Items" Icon="@Icons.Material.Outlined.ViewList">
                    <MudTable Items="_rows"
                              Dense="true"
                              Hover="true"
                              Bordered="true"
                              Striped="true">
                        <HeaderContent>
                            <MudTh OnClick="@(() => ChangeLineSort(LineSortColumn.Employee))"
                                   Style="cursor:pointer;">
                                Employee
                                @if (_lineSortColumn == LineSortColumn.Employee)
                                {
                                    <MudIcon Icon="@(_lineSortDescending? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward)"
                                             Size="Size.Small"
                                             Class="ml-1" />
                                }
                            </MudTh>

                            <MudTh OnClick="@(() => ChangeLineSort(LineSortColumn.Skill))"
                                   Style="cursor:pointer;">
                                Skill
                                @if (_lineSortColumn == LineSortColumn.Skill)
                                {
                                    <MudIcon Icon="@(_lineSortDescending? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward)"
                                             Size="Size.Small"
                                             Class="ml-1" />
                                }
                            </MudTh>

                            <MudTh OnClick="@(() => ChangeLineSort(LineSortColumn.Date))"
                                   Style="cursor:pointer;">
                                Date
                                @if (_lineSortColumn == LineSortColumn.Date)
                                {
                                    <MudIcon Icon="@(_lineSortDescending? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward)"
                                             Size="Size.Small"
                                             Class="ml-1" />
                                }
                            </MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.EmployeeName</MudTd>
                            <MudTd>@context.SkillTypeName</MudTd>
                            <MudTd>@context.SkillDate.ToString("yyyy-MM-dd")</MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Class="pa-4">No skills found with the selected filters.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudTabPanel>

                <!-- Tab 2: Per-employee summary -->
                <MudTabPanel Text="By Employee" Icon="@Icons.Material.Outlined.Groups">
                    <MudTable Items="_summaryRows"
                              Dense="true"
                              Hover="true"
                              Bordered="true"
                              Striped="true">
                        <HeaderContent>
                            <MudTh OnClick="@(() => ChangeSummarySort(SummarySortColumn.Employee))"
                                   Style="cursor:pointer;">
                                Employee
                                @if (_summarySortColumn == SummarySortColumn.Employee)
                                {
                                    <MudIcon Icon="@(_summarySortDescending? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward)"
                                             Size="Size.Small"
                                             Class="ml-1" />
                                }
                            </MudTh>

                            <MudTh>Skills</MudTh>

                            <MudTh OnClick="@(() => ChangeSummarySort(SummarySortColumn.EffectiveDate))"
                                   Style="cursor:pointer;">
                                Effective Date
                                @if (_summarySortColumn == SummarySortColumn.EffectiveDate)
                                {
                                    <MudIcon Icon="@(_summarySortDescending? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward)"
                                             Size="Size.Small"
                                             Class="ml-1" />
                                }
                            </MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.EmployeeName</MudTd>
                            <MudTd>
                                @{
                                    // Alphabetical list of skills for this employee
                                    var orderedSkills = context.Skills
                                    .OrderBy(s => s.SkillName)
                                    .ToList();
                                }
                                <MudChipSet T="string" ReadOnly="true">
                                    @for (int i = 0; i < orderedSkills.Count; i++)
                                    {
                                        var s = orderedSkills[i];
                                        <MudChip Color="@GetSkillColorByIndex(i)"
                                                 Variant="Variant.Filled"
                                                 Class="mr-2 mb-1">
                                            @s.SkillName
                                        </MudChip>
                                    }
                                </MudChipSet>
                            </MudTd>
                            <MudTd>@context.EffectiveDate.ToString("yyyy-MM-dd")</MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Class="pa-4">No employee skills found with the selected filters.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudTabPanel>

            </MudTabs>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    private string? _employeeSearch;
    private int? _selectedSkillTypeId;
    private int _tabIndex;

    private IReadOnlyList<SkillLookupRow> _rows = Array.Empty<SkillLookupRow>();
    private IReadOnlyList<SkillEmployeeSummaryRow> _summaryRows = Array.Empty<SkillEmployeeSummaryRow>();
    private IReadOnlyList<SkillType> _skillTypes = Array.Empty<SkillType>();


    private static readonly Color[] SkillColorPalette = new[]
    {
        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark,Color.Default,

        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark,Color.Default,

        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark, Color.Default
    };




    private Color GetSkillColorByIndex(int index)
    {
        if (index < 0)
            return Color.Default;

        return SkillColorPalette[index % SkillColorPalette.Length];
    }

    // -------- sorting state --------
    private enum LineSortColumn { Employee, Skill, Date }
    private LineSortColumn _lineSortColumn = LineSortColumn.Employee;
    private bool _lineSortDescending = false;

    private enum SummarySortColumn { Employee, EffectiveDate }
    private SummarySortColumn _summarySortColumn = SummarySortColumn.Employee;
    private bool _summarySortDescending = false;

    protected override async Task OnInitializedAsync()
    {
        _skillTypes = await SkillService.GetSkillTypesAsync(true);
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        try
        {
            var search = new SkillSearchVm(
                EmployeeSearch: _employeeSearch,
                SkillTypeId: _selectedSkillTypeId
            );

            _rows = await SkillService.SearchSkillsAsync(search);
            _summaryRows = await SkillService.GetEmployeeSkillSummariesAsync(search);

            // apply current sort preferences (defaults are Employee asc)
            ApplyLineSort();
            ApplySummarySort();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading skills: {ex.Message}", Severity.Error);
        }
    }

    // ------- line items sorting -------
    private void ChangeLineSort(LineSortColumn column)
    {
        if (_lineSortColumn == column)
            _lineSortDescending = !_lineSortDescending;
        else
        {
            _lineSortColumn = column;
            _lineSortDescending = false; // default to ascending when switching column
        }

        ApplyLineSort();
    }

    private void ApplyLineSort()
    {
        IEnumerable<SkillLookupRow> query = _rows;

        query = _lineSortColumn switch
        {
            LineSortColumn.Employee => _lineSortDescending
                ? query.OrderByDescending(r => r.EmployeeName)
                : query.OrderBy(r => r.EmployeeName),

            LineSortColumn.Skill => _lineSortDescending
                ? query.OrderByDescending(r => r.SkillTypeName)
                : query.OrderBy(r => r.SkillTypeName),

            LineSortColumn.Date => _lineSortDescending
                ? query.OrderByDescending(r => r.SkillDate)
                : query.OrderBy(r => r.SkillDate),

            _ => query
        };

        _rows = query.ToList();
    }

    // ------- summary sorting -------
    private void ChangeSummarySort(SummarySortColumn column)
    {
        if (_summarySortColumn == column)
            _summarySortDescending = !_summarySortDescending;
        else
        {
            _summarySortColumn = column;
            _summarySortDescending = false;
        }

        ApplySummarySort();
    }

    private void ApplySummarySort()
    {
        IEnumerable<SkillEmployeeSummaryRow> query = _summaryRows;

        query = _summarySortColumn switch
        {
            SummarySortColumn.Employee => _summarySortDescending
                ? query.OrderByDescending(r => r.EmployeeName)
                : query.OrderBy(r => r.EmployeeName),

            SummarySortColumn.EffectiveDate => _summarySortDescending
                ? query.OrderByDescending(r => r.EffectiveDate)
                : query.OrderBy(r => r.EffectiveDate),

            _ => query
        };

        _summaryRows = query.ToList();
    }
}
