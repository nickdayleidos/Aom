@page "/training/skills"
@attribute [Authorize(Roles = "Admin,OST,WFM,Manager,Supervisor")]

@using MudBlazor
@using MyApplication.Components.Model.AOM.Employee
@using MyApplication.Components.Service.Training

@inject ISkillsService SkillsService
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudStack Spacing="2">
    <MudPaper Class="pa-4" Outlined="true">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">Skills Lookup</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="@(() => Nav.NavigateTo("/training/skills/new"))">
                Add Skill
            </MudButton>
        </MudStack>

        <MudStack Class="mt-3" Spacing="2">
            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                <MudTextField @bind-Value="_employeeSearch"
                              Label="Employee (name)"
                              Dense
                              Immediate="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              Class="mr-2"
                              OnBlur="@(_ => RefreshAsync())" />

                <MudSelect T="int?"
                           Label="Skill Type"
                           Dense
                           @bind-Value="_selectedSkillTypeId"
                           Class="mr-2"
                           Clearable="true"
                           ResetValueOnEmptyText="true"
                           Style="min-width: 220px;">
                    @foreach (var st in _skillTypes)
                    {
                        <MudSelectItem Value="@((int?)st.Id)">@st.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSpacer />

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="RefreshAsync">
                    Search
                </MudButton>
            </MudStack>

            <MudTabs @bind-ActivePanelIndex="_tabIndex"
                     Rounded="true"
                     Elevation="0"
                     Class="mt-2">

                <MudTabPanel Text="Line Items" Icon="@Icons.Material.Outlined.ViewList">
                    <MudTable Items="_rows"
                              Dense="true"
                              Hover="true"
                              Bordered="true"
                              Striped="true">
                        <HeaderContent>
                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<SkillLookupRow, object>(x => x.EmployeeName)">
                                    Employee
                                </MudTableSortLabel>
                            </MudTh>

                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<SkillLookupRow, object>(x => x.SkillTypeName ?? string.Empty)">
                                    Skill
                                </MudTableSortLabel>
                            </MudTh>

                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<SkillLookupRow, object>(x => x.SkillDate)">
                                    Date
                                </MudTableSortLabel>
                            </MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.EmployeeName</MudTd>
                            <MudTd>@context.SkillTypeName</MudTd>
                            <MudTd>@context.SkillDate.ToString("yyyy-MM-dd")</MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Class="pa-4">No skills found with the selected filters.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudTabPanel>

                <MudTabPanel Text="By Employee" Icon="@Icons.Material.Outlined.Groups">
                    <MudTable Items="_summaryRows"
                              Dense="true"
                              Hover="true"
                              Bordered="true"
                              Striped="true">
                        <HeaderContent>
                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<SkillEmployeeSummaryRow, object>(x => x.EmployeeName)">
                                    Employee
                                </MudTableSortLabel>
                            </MudTh>

                            <MudTh>Skills</MudTh>

                            <MudTh>
                                <MudTableSortLabel SortBy="new Func<SkillEmployeeSummaryRow, object>(x => x.EffectiveDate)">
                                    Effective Date
                                </MudTableSortLabel>
                            </MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.EmployeeName</MudTd>
                            <MudTd>
                                @{
                                    // Alphabetical list of skills for this employee
                                    var orderedSkills = context.Skills
                                    .OrderBy(s => s.SkillName)
                                    .ToList();
                                }
                                <MudChipSet T="string" ReadOnly="true">
                                    @for (int i = 0; i < orderedSkills.Count; i++)
                                    {
                                        var s = orderedSkills[i];
                                        <MudChip Color="@GetSkillColorByIndex(i)"
                                                 Variant="Variant.Filled"
                                                 Class="mr-2 mb-1">
                                            @s.SkillName
                                        </MudChip>
                                    }
                                </MudChipSet>
                            </MudTd>
                            <MudTd>@context.EffectiveDate.ToString("yyyy-MM-dd")</MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Class="pa-4">No employee skills found with the selected filters.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudTabPanel>

            </MudTabs>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    private string? _employeeSearch;
    private int? _selectedSkillTypeId;
    private int _tabIndex;

    private IReadOnlyList<SkillLookupRow> _rows = Array.Empty<SkillLookupRow>();
    private IReadOnlyList<SkillEmployeeSummaryRow> _summaryRows = Array.Empty<SkillEmployeeSummaryRow>();
    private IReadOnlyList<SkillType> _skillTypes = Array.Empty<SkillType>();

    private static readonly Color[] SkillColorPalette = new[]
    {
        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark,Color.Default,

        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark,Color.Default,

        Color.Primary,Color.Secondary,Color.Tertiary,Color.Info,Color.Success,
        Color.Warning,Color.Error,Color.Dark, Color.Default
    };

    private Color GetSkillColorByIndex(int index)
    {
        if (index < 0)
            return Color.Default;
        return SkillColorPalette[index % SkillColorPalette.Length];
    }

    protected override async Task OnInitializedAsync()
    {
        _skillTypes = await SkillsService.GetSkillTypesAsync(true);
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        try
        {
            var search = new SkillSearchVm(
                EmployeeSearch: _employeeSearch,
                SkillTypeId: _selectedSkillTypeId
            );
            _rows = await SkillsService.SearchSkillsAsync(search);
            _summaryRows = await SkillsService.GetEmployeeSkillSummariesAsync(search);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading skills: {ex.Message}", Severity.Error);
        }
    }
}